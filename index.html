<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Cairo Font for Arabic support -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%); /* Soft Blue Gradient */
        }
        
        /* Modern Glass Effect */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* Apply Cairo font specifically to Arabic text areas if needed, or generally */
        .font-arabic {
            font-family: 'Cairo', 'Inter', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* New Animation for Congrats Modal */
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop-in {
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .attendance-tick {
            color: #10b981;
            font-weight: bold;
            font-size: 1.5rem;
        }
         .attendance-cross {
            color: #ef4444;
            font-weight: bold;
            font-size: 1.5rem;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .card-hover-effect {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        .card-hover-effect:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .card-hover-effect:active {
            transform: scale(0.98);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .back-button-sticky {
            position: -webkit-sticky;
            position: sticky;
            top: 1rem;
            z-index: 10;
        }
        .back-button-fab {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 50;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.5);
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }
        .back-button-fab:active {
            transform: scale(0.95);
        }
        body {
            overscroll-behavior: none;
        }
        .scrollable-content {
            overscroll-behavior: auto;
        }
        html, body {
            overscroll-behavior-y: contain;
        }
        .scrollable-content {
            -webkit-overflow-scrolling: touch;
        }
        input[type="text"] {
            font-size: 16px;
        }
        #mainViewContainer, #detailsContainer {
            transition: opacity 0.3s ease;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        /* Global button click effect (keeps other buttons interactive) */
        button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        /* STRICT OVERRIDE: Remove all animation/scaling from the Search button */
        #searchButton {
            transform: none !important;
            transition: none !important;
        }
        #searchButton:active {
            transform: none !important;
            opacity: 1 !important;
        }

        #zipgradeModal .bg-white, #practicalReviewModal .bg-white {
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Search Input Styling */
        .search-input-wrapper {
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            border-radius: 12px;
            transition: box-shadow 0.3s ease;
        }
        .search-input-wrapper:focus-within {
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.15);
        }

        @media (max-width: 640px) {
            .card-hover-effect {
                position: relative;
                overflow: hidden;
            }
            .card-hover-effect::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                border-radius: 50%;
                background: rgba(59, 130, 246, 0.1);
                transform: translate(-50%, -50%);
                transition: width 0.4s, height 0.4s;
            }
            .card-hover-effect:active::before {
                width: 300px;
                height: 300px;
            }
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="mainViewContainer">
        <div class="w-full max-w-5xl mx-auto p-4 md:p-8">
            
            <!-- Main Glass Panel -->
            <div class="w-full glass-panel rounded-2xl shadow-xl p-6 md:p-10 relative overflow-hidden">
                <!-- Decorative Top Border -->
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-400 via-indigo-500 to-purple-500"></div>

                <!-- UPDATED HEADER LAYOUT: Vertical on mobile, Horizontal on Desktop -->
                <div class="flex flex-col md:flex-row items-center mb-8 relative z-10 text-center md:text-left">
                    <div class="flex-shrink-0 bg-white p-2 rounded-xl shadow-sm border border-gray-100">
                        <img src="MUST.png" alt="MUST Logo" class="h-16 w-16 md:h-24 md:w-24 object-contain" onerror="this.src='https://placehold.co/100x100/1e3c72/FFFFFF?text=MUST&font=inter'"/>
                    </div>
                    
                    <!-- Modified Container for Collapsible Menu -->
                    <div class="mt-3 md:mt-0 md:ml-6 flex-grow w-full md:w-auto">
                        <!-- Title + Toggle Trigger -->
                        <div id="headerToggleBtn" class="flex items-center justify-center md:justify-start gap-2 cursor-default group select-none">
                            <h1 class="text-lg sm:text-xl md:text-3xl font-extrabold leading-tight tracking-tight text-slate-800 mb-1 md:mb-2">
                                Misr University for Science and Technology
                            </h1>
                            <!-- Chevron Icon (Hidden by default, controlled by JS via ENABLE_HEADER_COLLAPSE) -->
                            <div id="headerToggleIcon" class="hidden bg-blue-50 text-blue-500 rounded-full p-1 transform transition-transform duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </div>

                        <!-- Collapsible Details Section -->
                        <!-- Default: Visible (opacity-100 max-h-full) -->
                        <div id="headerDetails" class="overflow-hidden transition-all duration-300 ease-in-out opacity-100 max-h-full">
                            <div class="text-[11px] sm:text-sm md:text-base font-medium text-slate-500 flex flex-col gap-0.5 items-center md:items-start pt-1 md:pt-0 pb-2 md:pb-0">
                                <p>Faculty of Oral and Dental Surgery</p>
                                <p>PHYS.101</p>
                                <p>Fall 2025-2026</p>
                            </div>
                        </div>
                    </div>
                </div>

                <header class="text-center mb-8 pt-8 border-t border-gray-100 relative">
                    <div class="inline-block px-4 py-1.5 rounded-full bg-blue-50 text-blue-600 text-sm font-semibold mb-3 tracking-wide" id="greetingMessage">Welcome</div>
                    <h1 class="text-3xl md:text-4xl font-extrabold text-slate-800 tracking-tight">Student Portal</h1>
                    <p class="text-slate-400 mt-2 text-lg">Enter your Student ID to access your performance.</p>
                </header>

                <main>
                    <div class="max-w-xl mx-auto flex flex-col sm:flex-row gap-4 search-input-wrapper bg-white p-1.5">
                        <div class="relative flex-grow">
                            <input type="text" id="studentIdInput" placeholder="Enter Student ID..." class="w-full px-5 py-3 text-lg bg-transparent border-none focus:ring-0 text-slate-700 placeholder-slate-400">
                            <button id="searchButton" class="absolute right-1 top-1 bottom-1 bg-blue-600 hover:bg-blue-700 text-white px-6 rounded-lg font-semibold shadow-md transition-colors flex items-center justify-center">
                                Search
                            </button>
                        </div>
                    </div>

                    <div id="loading" class="text-center mt-8 hidden">
                         <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-blue-100 border-t-blue-600"></div>
                         <p class="text-slate-400 mt-3 font-medium animate-pulse">Fetching records...</p>
                    </div>
                    
                    <div id="resultsContainer" class="hidden">
                        <div id="mainBoard" class="fade-in mt-8 hidden">
                        </div>
                    </div>

                     <div id="error" class="text-center mt-8 p-4 bg-red-50 text-red-500 rounded-lg font-medium hidden border border-red-100"></div>
                </main>
            </div>
        </div>
        
        <footer class="w-full text-center p-8 mt-auto">
            <p class="text-slate-500 font-medium">Wishing you the best of luck in your studies! ‚ú®</p>
            <div class="mt-3 text-slate-400 text-sm">
                <p class="font-semibold text-slate-500">Dr. Mohamed Ali</p>
                <p>Center of Basic Sciences, Physics Department</p>
                <p>+201002836484</p>
            </div>
        </footer>
    </div>

    <div id="detailsContainer" class="w-full max-w-5xl mx-auto p-4 md:p-8 hidden scrollable-content">
        <div>
            <div id="attendanceContent" class="tab-content">
            </div>
            <div id="caContent" class="tab-content">
            </div>
        </div>
    </div>
    
    <!-- ZipGrade Modal -->
    <div id="zipgradeModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md text-center fade-in border border-gray-100">
            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">ZipGrade Access</h2>
            <p class="text-gray-500 mb-6">Use these credentials to log in.</p>

            <div class="space-y-5 text-left">
                <div>
                    <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wide mb-1.5">Student ID</label>
                    <div class="relative group">
                        <input type="text" id="modalStudentId" readonly class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 text-lg font-mono text-gray-700 focus:outline-none focus:border-blue-500 transition-colors">
                        <button onclick="copyToClipboard('modalStudentId', this)" class="absolute inset-y-0 right-0 px-4 text-gray-400 hover:text-blue-600 transition-colors">
                            <span class="copy-text hidden"></span>
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-left text-sm font-medium text-gray-500">Student Access Code</label>
                    <div class="relative mt-1">
                        <input type="text" id="modalAccessCode" readonly class="w-full bg-gray-100 border border-gray-300 rounded-md px-3 py-2 text-lg">
                         <button onclick="copyToClipboard('modalAccessCode', this)" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-blue-500">
                            <span class="copy-text hidden"></span>
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <a href="https://zipgrade.com/s/" target="_blank" class="mt-8 block w-full bg-blue-600 text-white font-bold py-3.5 px-6 rounded-xl hover:bg-blue-700 hover:shadow-lg transition-all transform hover:-translate-y-0.5">
                Go to ZipGrade Login
            </a>

            <button id="closeModalButton" class="mt-5 text-sm font-medium text-gray-400 hover:text-gray-600 transition-colors">Dismiss</button>
        </div>
    </div>

    <!-- Practical Review Modal (Refined for One-Line Fit on Mobile) -->
    <div id="practicalReviewModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden font-arabic">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md fade-in relative overflow-hidden border border-gray-100">
            <!-- Decorative circle -->
            <div class="absolute -top-12 -left-12 w-32 h-32 bg-yellow-100 rounded-full blur-2xl opacity-60"></div>
            
            <!-- Header -->
            <div class="flex flex-col items-center justify-center border-b border-gray-100 pb-5 mb-5 relative z-10" dir="rtl">
                 <div class="flex items-center gap-2 mb-2 w-full justify-center">
                    <span class="text-2xl sm:text-3xl filter drop-shadow-sm">üîî</span>
                    <!-- Title resized and forced to one line -->
                    <h2 class="text-base sm:text-xl font-bold text-gray-800 whitespace-nowrap tracking-wide">ÿ™ŸÜŸàŸäŸá ŸáÿßŸÖ: ŸÖÿ±ÿßÿ¨ÿπÿ© ÿ™ÿµÿ≠Ÿäÿ≠ ÿßŸÑÿπŸÖŸÑŸä</h2>
                 </div>
                 <p class="text-gray-500 text-center leading-relaxed text-sm sm:text-base font-medium">
                    ŸäŸÖŸÉŸÜŸÉŸÖ ŸÖÿ±ÿßÿ¨ÿπÿ© Ÿàÿ™ÿØŸÇŸäŸÇ ÿ™ÿµÿ≠Ÿäÿ≠ ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿπŸÖŸÑŸä ŸÖŸÜ ÿßŸÑŸÖŸÇÿ±ÿ±.
                </p>
            </div>

            <!-- Details Table (Table Layout - LTR & English Labels) -->
            <div class="bg-slate-50 p-5 rounded-xl border border-slate-100 mb-6 overflow-hidden relative z-10">
                <!-- Text size reduced to text-xs on mobile to ensure single line fit -->
                <table class="w-full text-left text-xs sm:text-sm md:text-base">
                    <tbody>
                        <tr class="border-b border-slate-200 last:border-0">
                            <td class="py-2.5 font-bold text-slate-500 whitespace-nowrap pr-3 w-auto uppercase text-[10px] sm:text-xs tracking-wider">Experiment</td>
                            <td class="py-2.5 text-slate-800 font-bold whitespace-nowrap text-right" id="reviewExperiment"></td>
                        </tr>
                        <tr class="border-b border-slate-200 last:border-0">
                            <td class="py-2.5 font-bold text-slate-500 whitespace-nowrap pr-3 uppercase text-[10px] sm:text-xs tracking-wider">Reviewer</td>
                            <td class="py-2.5 text-slate-800 font-bold whitespace-nowrap text-right" id="reviewName"></td>
                        </tr>
                        <tr class="border-b border-slate-200 last:border-0">
                            <td class="py-2.5 font-bold text-slate-500 whitespace-nowrap pr-3 uppercase text-[10px] sm:text-xs tracking-wider">Location</td>
                            <td class="py-2.5 text-slate-800 font-bold whitespace-nowrap text-right" id="reviewLocation">304 LB PH</td>
                        </tr>
                        <tr class="last:border-0">
                            <td class="py-2.5 font-bold text-slate-500 whitespace-nowrap pr-3 align-top uppercase text-[10px] sm:text-xs tracking-wider">Date</td>
                            <td class="py-2.5 text-slate-800 font-bold whitespace-nowrap text-right" id="reviewDate"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <p class="text-xs sm:text-sm text-red-500 font-bold mb-6 text-center bg-red-50 py-2 rounded-lg border border-red-100" dir="rtl">
                 ŸÖŸÑÿßÿ≠ÿ∏ÿ©: Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ŸÅŸä ÿßŸÑŸÖŸàÿπÿØ ÿßŸÑŸÖÿ≠ÿØÿØ ŸÑÿ•ŸÜŸáÿßÿ° ÿπŸÖŸÑŸäÿ© ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©.
            </p>

            <button id="closeReviewModalButton" class="w-full bg-slate-100 text-slate-700 font-bold py-3.5 px-6 rounded-xl hover:bg-slate-200 transition-colors">
                ÿ•ÿ∫ŸÑÿßŸÇ
            </button>
        </div>
    </div>

    <!-- Congratulations Modal (Updated for Game Style Transparency) -->
    <div id="congratsModal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-[60] hidden backdrop-blur-sm">
        <div class="w-full max-w-sm text-center relative animate-pop-in">
            <!-- Decorative Glow Behind Trophy -->
            <div id="congratsBgGradient" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-yellow-500 rounded-full blur-3xl opacity-30 -z-10"></div>
            
            <div class="relative z-10 flex flex-col items-center">
                <!-- Icon with bounce animation -->
                <div id="congratsIcon" class="text-7xl sm:text-9xl mb-6 sm:mb-8 animate-bounce drop-shadow-2xl filter">üèÜ</div>
                
                <!-- Increased margin-bottom (mb-6) and padding to prevent clipping of 'g' -->
                <h2 id="congratsTitle" class="text-3xl sm:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 mb-6 pb-2 drop-shadow-[0_4px_4px_rgba(0,0,0,0.8)] tracking-tight leading-tight">
                    Congratulations!
                </h2>
                
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 w-full mb-8 border border-white/10 shadow-2xl">
                    <p id="congratsRankMsg" class="text-2xl font-bold text-white mb-1 drop-shadow-md">
                        You are Ranked #1!
                    </p>
                    <div class="h-0.5 w-16 bg-white/30 mx-auto mb-2 rounded-full"></div>
                    <p class="text-gray-200 text-base font-medium drop-shadow-sm leading-relaxed">
                        Outstanding performance.<br>Keep up the amazing work!
                    </p>
                </div>
                
                <button id="congratsButton" onclick="closeCongratsModal()" class="w-full bg-gradient-to-b from-yellow-400 to-orange-600 border-b-4 border-orange-800 text-white font-bold py-4 px-10 rounded-2xl shadow-xl transform transition active:scale-95 active:border-b-0 active:translate-y-1 hover:brightness-110 uppercase tracking-wider text-lg">
                    Awesome!
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const ENABLE_HEADER_COLLAPSE = false; // Set to "true" to enable slide-down menu on mobile
        const SHOW_FINAL_LAB_EXAM = false;    // Set to "true" to show the Final Lab Exam schedule card
        // ---------------------

        // Set dynamic greeting
        function setGreeting() {
            const hour = new Date().getHours();
            const greetingElement = document.getElementById('greetingMessage');
            let greeting = "Welcome";
            
            if (hour >= 5 && hour < 12) {
                greeting = "Good Morning ‚òÄÔ∏è";
            } else if (hour >= 12 && hour < 18) {
                greeting = "Good Afternoon üå§Ô∏è";
            } else {
                greeting = "Good Evening üåô";
            }
            
            if (greetingElement) {
                greetingElement.textContent = greeting;
            }
        }
        
        // Initial set and interval to update
        setGreeting();
        setInterval(setGreeting, 60000); // Check every minute

        const GOOGLE_SHEET_1_BASE_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTTAvVKy59t4ZTV_GQPKQbUS-tchpK9OugsPXL41ScMQXsA1pDh467cksdR32pct8_bjgpOJ4NpgrZA/pub?output=csv&single=true';
        const FINAL_EXAM_GID = '1063209357';
        
        const SECTION_GIDS_1 = {
            'All': '1650908958', 'A': '1620275840', 'B': '1661871665', 'C': '804746623', 'D': '1998860796', 'E': '1432194061', 'F': '1174976610', 'G': '630589668', 'H': '340172703', 'I': '1823887500', 'J': '1811748047', 'K': '289568000', 'L': '1058769797', 'M': '672465296', 'N': '2018867860', 'O': '2510390', 'P': '1022038284', 'Q': '747459593', 'R': '1912599889', 'S': '554652905', 'T': '1568050738'
        };

        const GOOGLE_SHEET_2_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSwOgvVGMBZkhsJY_dTFepiWNuK42nVXTg5ATU1jd0In027rMCC8Qx0o8Wcl7JHMxCNGtUXUMpVsiLv/pub?output=csv';

        const studentIdInput = document.getElementById('studentIdInput');
        const searchButton = document.getElementById('searchButton');
        
        const mainViewContainer = document.getElementById('mainViewContainer');
        const detailsContainer = document.getElementById('detailsContainer');
        
        const resultsContainer = document.getElementById('resultsContainer');
        const mainBoard = document.getElementById('mainBoard');    
        const attendanceContent = document.getElementById('attendanceContent');
        const caContent = document.getElementById('caContent');
        
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');

        let currentStudentList = [];
        let fullAttendanceData = {};
        let currentFinalExamStudent = null; // Store for modal access
        
        let touchstartX = 0;
        let touchendX = 0;
        const swipeThreshold = 80;
        let touchstartY = 0;
        let touchendY = 0;
        let isScrolling = null;
        let swipeHandled = false;

        document.body.addEventListener('touchstart', e => {
            if (!detailsContainer.classList.contains('hidden')) {
                touchstartX = e.changedTouches[0].screenX;
                touchstartY = e.changedTouches[0].screenY;
                isScrolling = null;
                swipeHandled = false;
                
                const fab = document.querySelector('.back-button-fab');
                if (fab && touchstartX < (window.innerWidth / 8)) {
                    fab.style.transform = 'scale(1.1)';
                }
            }
        }, { passive: true });

        document.body.addEventListener('touchmove', e => {
            if (!detailsContainer.classList.contains('hidden') && touchstartX !== 0) {
                const deltaX = e.changedTouches[0].screenX - touchstartX;
                const deltaY = e.changedTouches[0].screenY - touchstartY;

                if (isScrolling === null) {
                    isScrolling = Math.abs(deltaY) > Math.abs(deltaX);
                }

                if (!isScrolling && deltaX > 0 && touchstartX < (window.innerWidth / 8)) {
                    if (e.cancelable) {
                        e.preventDefault();
                    }
                    
                    swipeHandled = true;
                    
                    const progress = Math.min(deltaX / 150, 1);
                    detailsContainer.style.opacity = 1 - (progress * 0.3);
                    detailsContainer.style.transform = `translateX(${deltaX * 0.5}px)`;
                }
            }
        }, { passive: false });

        document.body.addEventListener('touchend', e => {
            if (!detailsContainer.classList.contains('hidden') && touchstartX !== 0) {
                touchendX = e.changedTouches[0].screenX;
                touchendY = e.changedTouches[0].screenY;
                
                if (swipeHandled) {
                    handleSwipeGesture(e); // Pass the event object
                }
                
                detailsContainer.style.opacity = '1';
                detailsContainer.style.transform = 'translateX(0)';
                const fab = document.querySelector('.back-button-fab');
                if (fab) fab.style.transform = 'scale(1)';
            }
            touchstartX = 0;
            touchstartY = 0;
            touchendX = 0;
            touchendY = 0;
            isScrolling = null;
            swipeHandled = false;
        });

        function handleSwipeGesture(event) {
            const deltaX = touchendX - touchstartX;
            const deltaY = touchendY - touchstartY;

            if (Math.abs(deltaX) > Math.abs(deltaY) && deltaX > swipeThreshold) {
                if (touchstartX < (window.innerWidth / 8)) {
                    if (event) { // Check if event exists
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    
                    hideDetailPage();
                    
                    if (window.navigator && window.navigator.vibrate) {
                        window.navigator.vibrate(10);
                    }
                }
            }
        }

        async function fetchSheetData(baseUrl, gid) {
            const fetchUrl = `${baseUrl}&gid=${gid}`;
            const response = await fetch(fetchUrl);
            if (!response.ok) throw new Error(`Network error fetching data for GID ${gid}.`);
            return await response.text();
        }
        
        function parseAttendanceCSV(text) {
            const rows = text.split(/\r?\n/).map(row => row.split(',').map(cell => {
                let cleanCell = cell.trim();
                if (cleanCell.startsWith('"') && cleanCell.endsWith('"')) { cleanCell = cleanCell.substring(1, cleanCell.length - 1); }
                return cleanCell;
            }));
            if (rows.length < 5) return [];
            const topicRow = rows[0], dateRow = rows[1], headerRow = rows[3], dataRows = rows.slice(4);
            const structuredHeaders = [];
            let currentTopic = '', currentDate = '';
            for (let i = 0; i < headerRow.length; i++) {
                if (topicRow[i]) currentTopic = topicRow[i];
                if (dateRow[i]) currentDate = dateRow[i];
                let header = headerRow[i];
                if (i === 5) { structuredHeaders.push('Section'); continue; }
                if (header === 'Att.' || header === 'Deg.') { structuredHeaders.push(`${currentTopic}|${currentDate}|${header}`); }    
                else { structuredHeaders.push(header); }
            }
            const data = dataRows.map(row => {
                const student = {};
                structuredHeaders.forEach((header, index) => { student[header] = row[index] || ''; });
                return student;
            }).filter(student => student['Id']);
            return data;
        }

        function parseCaCSV(text) {
            const rows = text.split(/\r?\n/).map(row => row.split(',').map(cell => cell.trim()));
            if (rows.length < 6) return [];    
            const headers = rows[4];    
            const dataRows = rows.slice(5);

            const idColumnIndex = headers.findIndex(h => h.toLowerCase().includes('id'));
            const accessCodeColumnIndex = headers.findIndex(h => h.toLowerCase().includes('access code'));
            
            if (idColumnIndex === -1) {
                console.error("Could not find a column with 'id' in the C.A. sheet's 5th row.");
                return [];    
            }
            return dataRows.map(row => {
                const student = {};
                headers.forEach((header, index) => {
                    student[header] = row[index] || '';
                });
                student['Id'] = row[idColumnIndex] || '';
                student['StudentAccessCode'] = accessCodeColumnIndex !== -1 ? row[accessCodeColumnIndex] || '' : '';
                return student;
            }).filter(student => student['Id'] && student['Id'].trim() !== '');
        }

        // --- FUNCTION TO PARSE FINAL EXAM DATA ---
        function parseFinalExamCSV(text) {
             const rows = text.split(/\r?\n/).map(row => row.split(',').map(cell => {
                let cleanCell = cell.trim();
                if (cleanCell.startsWith('"') && cleanCell.endsWith('"')) {
                     cleanCell = cleanCell.substring(1, cleanCell.length - 1);
                }
                return cleanCell;
            }));
            
            if (rows.length < 2) return [];

            const dataRows = rows.slice(1);

            return dataRows.map(row => {
                return {
                    id: row[1] || '',
                    day: row[4] || '',
                    time: row[5] || '',
                    date: row[6] || '',
                    location: row[7] || '',
                    experiment: row[8] || '', // Column I (index 8) - ÿßŸÑÿ™ÿ¨ÿ±ÿ®ÿ©
                    reviewer: row[12] || '',  // Column M (index 12) - ÿßŸÑŸÖÿπŸÜŸä ÿ®ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©
                    reviewDate: row[13] || '' // Column N (index 13) - ÿßŸÑŸÖŸàÿπÿØ
                };
            }).filter(item => item.id && item.id.trim() !== '');
        }

        async function findAndDisplayStudent() {
            const searchId = studentIdInput.value.trim();
            if (!searchId) { showError('Please enter a Student ID.'); return; }
            
            loadingDiv.classList.remove('hidden');
            errorDiv.classList.add('hidden');
            resultsContainer.classList.add('hidden');    
            mainBoard.classList.add('hidden');
            
            try {
                if (GOOGLE_SHEET_2_URL.startsWith('REPLACE_WITH')) {
                    throw new Error('The Continuous Assessment sheet URL is not configured.');
                }
                
                const allSheetCsv = await fetchSheetData(GOOGLE_SHEET_1_BASE_URL, SECTION_GIDS_1['All']);
                const allStudents = parseAttendanceCSV(allSheetCsv);
                const studentFromAll = allStudents.find(s => s['Id'] === searchId);

                if (!studentFromAll) {
                    showError(`No record found for Student ID: ${searchId}.`);
                    loadingDiv.classList.add('hidden');
                    return;
                }
                
                const studentSection = studentFromAll['Section'];
                const sectionGid = SECTION_GIDS_1[studentSection];
                
                if (!sectionGid) {
                    throw new Error(`Invalid or unconfigured section "${studentSection}" found for student.`);
                }

                const [sectionSheetCsv, caResponse, finalExamCsv] = await Promise.all([
                    fetchSheetData(GOOGLE_SHEET_1_BASE_URL, sectionGid),
                    fetch(GOOGLE_SHEET_2_URL),
                    fetchSheetData(GOOGLE_SHEET_1_BASE_URL, FINAL_EXAM_GID)
                ]);

                if (!caResponse.ok) {
                    throw new Error('Network error fetching C.A. data.');
                }
                const caCsv = await caResponse.text();

                const sectionAttendanceData = parseAttendanceCSV(sectionSheetCsv);
                
                currentStudentList = sectionAttendanceData.map(s => s['Id']).sort();
                
                const caData = parseCaCSV(caCsv);
                const finalExamData = parseFinalExamCSV(finalExamCsv);

                const attendanceStudent = sectionAttendanceData.find(s => s['Id'] === searchId);
                const caStudent = caData.find(s => s['Id'] === searchId);
                const finalExamStudent = finalExamData.find(s => s.id === searchId);
                
                currentFinalExamStudent = finalExamStudent; // Save for modal

                attendanceContent.innerHTML = '';
                caContent.innerHTML = '';
                mainBoard.innerHTML = '';

                displayMainBoard(attendanceStudent, caStudent, studentSection, finalExamStudent);
                displayAttendanceInfo(attendanceStudent);
                displayCAInfo(caStudent);    
                
                mainViewContainer.classList.remove('hidden');
                resultsContainer.classList.remove('hidden');
                mainBoard.classList.remove('hidden');
                detailsContainer.classList.add('hidden');

            } catch (error) {
                console.error('Error during search:', error);
                showError(error.message || 'Could not load student data. Please check configurations and connection.');
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }
        
        function displayMainBoard(attendanceStudent, caStudent, studentSection, finalExamStudent) {
            const studentName = attendanceStudent ? attendanceStudent['Name'] : (caStudent ? caStudent['Name'] : 'N/A');
            const studentId = attendanceStudent ? attendanceStudent['Id'] : (caStudent ? caStudent['Id'] : 'N/A');

            const labScore = attendanceStudent ? attendanceStudent['Total'] : 'N/A';
            const labScoreNum = parseFloat(labScore) || 0; // Get numeric value for sum

            const quiz1 = caStudent ? parseFloat(caStudent['Q1/10'] || 0) : 0;
            const quiz2 = caStudent ? parseFloat(caStudent['Q2/15'] || 0) : 0;
            const quiz3 = caStudent ? parseFloat(caStudent['Q3/15'] || 0) : 0;
            const quizTotal = quiz1 + quiz2 + quiz3;
            const practicalScore = caStudent ? caStudent['pra'] : 'N/A';
            const practicalScoreNum = parseFloat(practicalScore) || 0; // Get numeric value for sum
            
            // Calculate total score locally
            const calculatedTotal = labScoreNum + quizTotal + practicalScoreNum;
            // Check if any data was available to make a calculation
            const totalScore = (attendanceStudent || caStudent) ? Math.round(calculatedTotal) : 'N/A'; // Display approximated to nearest whole number

            const rank = caStudent ? (caStudent['Rank'] || 'N/A') : 'N/A';
            const rankNum = parseInt(rank);

            // --- Top 10 Celebration Logic (Updated from Top 3) ---
            if (!isNaN(rankNum) && rankNum >= 1 && rankNum <= 10) {
                // Execute immediately without delay
                updateCongratsModal(rankNum);
                fireConfetti();
                playCelebrationSound();
                showCongratsModal();
            }

            const quizCircle = caStudent ? createCircularProgressBar(quizTotal, 40, quizTotal.toFixed(1), 'Quizzes') : createCircularProgressBar(0, 40, 'N/A', 'Quizzes');
            const labScoreCircle = attendanceStudent ? createCircularProgressBar(labScore, 10, labScore, 'Lab Score') : createCircularProgressBar(0, 10, 'N/A', 'Lab Score');
            const practicalCircle = caStudent ? createCircularProgressBar(practicalScore, 20, practicalScore, 'Final Practical') : createCircularProgressBar(0, 20, 'N/A', 'Final Practical');
            
            // Modified font size for mobile to ensure it fits in 1 row
            const totalScoreDisplay = totalScore !== 'N/A' ? totalScore : 'N/A';
            const totalScoreHtml = `<p class="text-2xl sm:text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600 whitespace-nowrap px-2 py-1 sm:px-4 sm:py-2">${totalScoreDisplay} / 70</p>`;
            const rankHtml = caStudent ? `<p class="text-base sm:text-lg font-semibold text-slate-500 flex items-center justify-center gap-1 sm:gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 text-yellow-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>Rank: <span class="text-xl sm:text-2xl text-slate-700 font-bold">${rank}</span></p>` : '';

            // --- Construct Final Exam Card ---
            let finalExamHtml = '';
            // Only show if configuration is TRUE AND student has exam data
            if (SHOW_FINAL_LAB_EXAM && finalExamStudent) {
                finalExamHtml = `
                <div class="mb-8 mx-auto max-w-4xl transform transition-all hover:scale-[1.01]">
                    <div class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-2xl shadow-xl text-white overflow-hidden relative">
                         <!-- Subtle Grain/Texture -->
                         <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                         
                         <div class="absolute top-0 right-0 -mr-12 -mt-12 w-48 h-48 rounded-full bg-white opacity-10 blur-3xl"></div>
                         <div class="absolute bottom-0 left-0 -ml-12 -mb-12 w-48 h-48 rounded-full bg-white opacity-10 blur-3xl"></div>
                         
                         <div class="p-8 relative z-10">
                            <div class="flex items-center mb-6 border-b border-white/20 pb-4">
                                <div class="bg-white/20 p-2 rounded-lg mr-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                </div>
                                <h3 class="text-2xl font-bold tracking-tight text-white">Final Lab Exam</h3>
                            </div>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                                <div class="bg-white/10 rounded-xl p-4 backdrop-blur-sm border border-white/10 hover:bg-white/20 transition-colors">
                                    <p class="text-xs uppercase tracking-wider opacity-70 mb-1 font-semibold">Date</p>
                                    <p class="text-xl font-bold text-white">${finalExamStudent.date}</p>
                                    <p class="text-sm font-medium opacity-90 text-indigo-100">${finalExamStudent.day}</p>
                                </div>
                                <div class="bg-white/10 rounded-xl p-4 backdrop-blur-sm border border-white/10 hover:bg-white/20 transition-colors">
                                    <p class="text-xs uppercase tracking-wider opacity-70 mb-1 font-semibold">Time</p>
                                    <p class="text-xl font-bold text-white">${finalExamStudent.time}</p>
                                </div>
                                <div class="bg-white/10 rounded-xl p-4 backdrop-blur-sm border border-white/10 hover:bg-white/20 transition-colors">
                                    <p class="text-xs uppercase tracking-wider opacity-70 mb-1 font-semibold">Location</p>
                                    <div class="flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 opacity-80" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        <p class="text-xl font-bold text-white">${finalExamStudent.location}</p>
                                    </div>
                                </div>
                            </div>
                         </div>
                    </div>
                </div>
                `;
            }

            const mainBoardHtml = `
                <div class="mb-8 text-center">
                    <h2 class="text-2xl md:text-3xl font-extrabold text-slate-800 tracking-tight">${studentName}</h2>
                    <div class="inline-flex items-center gap-4 mt-2 text-slate-500 font-medium bg-white px-4 py-1 rounded-full shadow-sm border border-gray-100">
                        <span>ID: <span class="text-slate-800 font-mono">${studentId}</span></span>
                        <span class="w-1 h-1 bg-slate-300 rounded-full"></span>
                        <span>Section: <span class="text-slate-800">${studentSection || 'N/A'}</span></span>
                    </div>
                </div>
                
                <div class="text-center mb-10 pt-8 border-t border-dashed border-slate-200">
                    <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">Overall Performance</h3>
                    <!-- Changed to flex-row to force single row layout on all screens -->
                    <div class="flex flex-row items-center justify-center gap-0 sm:gap-12 px-2 sm:px-4 divide-x divide-slate-200">
                        <div class="flex flex-col items-center flex-1 px-2">
                            ${totalScoreHtml}
                            <span class="text-[10px] sm:text-xs font-semibold text-slate-400 mt-1">TOTAL SCORE</span>
                        </div>
                        <!-- Divider logic handled by divide-x class on parent, keeping structure clean -->
                        <div class="flex flex-col items-center flex-1 px-2">
                            ${rankHtml}
                            <span class="text-[10px] sm:text-xs font-semibold text-slate-400 mt-1">CLASS RANK</span>
                        </div>
                    </div>
                </div>
                
                ${finalExamHtml}

                <h3 class="text-xl font-bold text-slate-700 mb-6 mt-10 flex items-center">
                    <span class="w-1 h-6 bg-blue-500 rounded-full mr-3"></span>
                    Detailed Grades
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    <div id="quizzesCardTrigger" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center card-hover-effect ${caStudent ? 'cursor-pointer' : 'opacity-60'} group">
                        ${quizCircle}
                    </div>
                    <div id="labScoreCardTrigger" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center card-hover-effect ${attendanceStudent ? 'cursor-pointer' : 'opacity-60'} group">
                        ${labScoreCircle}
                    </div>
                    <!-- Added ID and Logic for triggering the Practical Review Modal -->
                    <div id="practicalScoreCardTrigger" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center card-hover-effect ${finalExamStudent ? 'cursor-pointer' : 'opacity-60'} group">
                        ${practicalCircle}
                    </div>
                </div>
            `;
            mainBoard.innerHTML = mainBoardHtml;
        }

        const congratsModal = document.getElementById('congratsModal');
        const congratsBgGradient = document.getElementById('congratsBgGradient');
        const congratsIcon = document.getElementById('congratsIcon');
        const congratsTitle = document.getElementById('congratsTitle');
        const congratsRankMsg = document.getElementById('congratsRankMsg');
        const congratsButton = document.getElementById('congratsButton');

        function updateCongratsModal(rank) {
            // Default Gold/Rank 1 settings
            let iconContent = 'üèÜ'; // Default emoji content
            let isSvg = false;      // Flag to check if we use SVG HTML instead of text emoji
            
            // Game-style text gradients (Top to Bottom)
            let titleGradient = 'from-yellow-300 to-yellow-600'; 
            // Glow color
            let glowColor = 'bg-yellow-500';
            // Button style
            let btnGradient = 'from-yellow-400 to-orange-600 border-orange-800';
            let ringColor = 'focus:ring-orange-400';
            let msg = `You are Ranked #${rank}!`;
            
            // Icon Styling (Gold) - Shiny and Metallic
            // Updated to be responsive: text-7xl on mobile, text-9xl on desktop
            let iconStyle = 'text-7xl sm:text-9xl mb-6 sm:mb-8 animate-bounce drop-shadow-[0_0_35px_rgba(234,179,8,0.6)] filter brightness-110 saturate-125 contrast-125';

            if (rank === 2) {
                // Silver Settings - Metallic & Shiny
                iconContent = 'ü•à';
                titleGradient = 'from-[#E8E8E8] via-[#BCC6CC] to-[#757575]';
                glowColor = 'bg-[#C0C0C0]';
                btnGradient = 'from-[#C0C0C0] to-[#707070] border-[#505050]';
                ringColor = 'focus:ring-gray-400';
                
                // Silver Icon Specifics:
                iconStyle = 'text-7xl sm:text-9xl mb-6 sm:mb-8 animate-bounce drop-shadow-[0_0_35px_#C0C0C0] filter grayscale(1) brightness-125 contrast-150';
                
            } else if (rank === 3) {
                // Bronze Settings - Metallic & Shiny
                iconContent = 'ü•â';
                titleGradient = 'from-orange-300 to-orange-700'; 
                glowColor = 'bg-orange-600';
                btnGradient = 'from-orange-400 to-orange-700 border-orange-900';
                ringColor = 'focus:ring-orange-500';
                
                // Bronze Icon Specifics:
                iconStyle = 'text-7xl sm:text-9xl mb-6 sm:mb-8 animate-bounce drop-shadow-[0_0_35px_rgba(180,83,9,0.6)] filter sepia-[.5] brightness-110 contrast-125';
            } else if (rank >= 4 && rank <= 10) {
                // Top 10 (4-10) - Top 10 Gold Badge (Inline SVG)
                isSvg = true;
                // Brown/Gold theme to match the badge
                titleGradient = 'from-amber-500 via-yellow-400 to-amber-600';
                glowColor = 'bg-yellow-500';
                btnGradient = 'from-amber-600 to-yellow-700 border-amber-900';
                ringColor = 'focus:ring-amber-500';
                
                // Inline SVG for the Top 10 Badge (Circular Badge Design - No Wreath)
                iconContent = `
                <svg width="100%" height="100%" viewBox="0 0 500 500" class="w-32 h-32 sm:w-48 sm:h-48 mx-auto mb-6 animate-bounce drop-shadow-2xl filter saturate-125">
                  <defs>
                    <linearGradient id="goldGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" style="stop-color:#FDB931;stop-opacity:1" />
                      <stop offset="40%" style="stop-color:#FFD700;stop-opacity:1" />
                      <stop offset="100%" style="stop-color:#B8860B;stop-opacity:1" />
                    </linearGradient>
                    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                      <feDropShadow dx="2" dy="4" stdDeviation="3" flood-color="rgba(0,0,0,0.4)"/>
                    </filter>
                  </defs>

                  <!-- Circular Border -->
                  <circle cx="250" cy="250" r="230" fill="none" stroke="url(#goldGradient)" stroke-width="15" filter="url(#shadow)" />
                  <circle cx="250" cy="250" r="215" fill="none" stroke="#78350F" stroke-width="2" opacity="0.3" />

                  <!-- Crown Group (Centered inside circle) -->
                  <g transform="translate(125, 40)" filter="url(#shadow)">
                     <path d="M 50 100 L 50 40 L 90 70 L 125 20 L 160 70 L 200 40 L 200 100 Z" fill="url(#goldGradient)" stroke="#B45309" stroke-width="2"/>
                     <!-- Jewels -->
                     <circle cx="50" cy="40" r="6" fill="#FFF"/>
                     <circle cx="125" cy="20" r="6" fill="#FFF"/>
                     <circle cx="200" cy="40" r="6" fill="#FFF"/>
                  </g>

                  <!-- Text Group (Centered) -->
                  <g transform="translate(250, 300)" text-anchor="middle" filter="url(#shadow)">
                    <text y="0" font-family="serif" font-weight="900" font-size="180" fill="url(#goldGradient)" stroke="#78350F" stroke-width="1.5">10</text>
                    <text y="60" font-family="serif" font-weight="bold" font-size="50" letter-spacing="8" fill="url(#goldGradient)" stroke="#78350F" stroke-width="0.5">TOP</text>
                  </g>
                </svg>
                `;
            }

            // Apply updates
            if (isSvg) {
                // For SVG content, use innerHTML and clear base classes
                congratsIcon.innerHTML = iconContent;
                congratsIcon.className = ''; 
            } else {
                // For plain text emojis, use textContent and apply base classes
                congratsIcon.textContent = iconContent;
                congratsIcon.className = iconStyle;
            }
            
            congratsRankMsg.textContent = msg;
            
            // Apply Glow Class
            // Reset class list first to remove old colors, then add base classes + new color
            congratsBgGradient.className = `absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 rounded-full blur-3xl opacity-30 -z-10 ${glowColor}`;
            
            // Apply Title Gradient
            // Updated to be responsive: text-3xl on mobile, text-5xl on desktop
            congratsTitle.className = `text-3xl sm:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-b ${titleGradient} mb-6 pb-2 drop-shadow-[0_4px_4px_rgba(0,0,0,0.8)] tracking-tight leading-tight`;
            
            // Apply Button Styles
            congratsButton.className = `w-full bg-gradient-to-b ${btnGradient} border-b-4 text-white font-bold py-4 px-10 rounded-2xl shadow-xl transform transition active:scale-95 active:border-b-0 active:translate-y-1 hover:brightness-110 uppercase tracking-wider text-lg focus:outline-none focus:ring-2 ${ringColor} focus:ring-opacity-50`;
        }
        
        function showCongratsModal() {
            congratsModal.classList.remove('hidden');
        }

        function closeCongratsModal() {
            congratsModal.classList.add('hidden');
        }

        function playCelebrationSound() {
            // ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿµŸàÿ™Ÿä ÿßŸÑÿ£ŸàŸÑ (ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ ÿßŸÑÿßÿ≠ÿ™ŸÅÿßŸÑŸäÿ©)
            const soundUrl1 = "brass-horn-fanfare-charge-epic-stock-media-1-00-03.mp3";
            // ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿµŸàÿ™Ÿä ÿßŸÑÿ´ÿßŸÜŸä (ÿµŸàÿ™ŸÉ)
            const soundUrl2 = "my_voice.mp3";
            
            const audioObj1 = new Audio(soundUrl1);
            audioObj1.volume = 0.6;
            
            // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ£ŸàŸÑ
            const playPromise = audioObj1.play();
            
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.log("Audio 1 play failed (file not found or browser policy):", error);
                });
            }

            // ÿπŸÜÿØ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ£ŸàŸÑÿå ŸÇŸÖ ÿ®ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ´ÿßŸÜŸä
            audioObj1.onended = function() {
                const audioObj2 = new Audio(soundUrl2);
                audioObj2.volume = 0.6;
                audioObj2.play().catch(error => {
                    console.log("Audio 2 play failed:", error);
                });
            };
        }

        function fireConfetti() {
            var duration = 3 * 1000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 70 };

            function randomInRange(min, max) {
              return Math.random() * (max - min) + min;
            }

            var interval = setInterval(function() {
              var timeLeft = animationEnd - Date.now();

              if (timeLeft <= 0) {
                return clearInterval(interval);
              }

              var particleCount = 50 * (timeLeft / duration);
              // since particles fall down, start a bit higher than random
              confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
              confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }

        // ... (Rest of the existing functions: displayAttendanceInfo, displayCAInfo, createCircularProgressBar, zipgrade logic, etc.) ...
        
        function displayAttendanceInfo(student) {
            if (!student) {
                 attendanceContent.innerHTML = '<button class="back-button back-button-sticky hidden sm:block mb-4 bg-white text-slate-700 border border-slate-200 shadow-sm font-semibold px-5 py-2.5 rounded-xl hover:bg-slate-50 transition-colors">‚Üê Back to Main Board</button><div class="text-center py-10"><p class="text-slate-400 font-medium">No lab data found for this student.</p></div><button class="back-button back-button-fab sm:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>';
                 return;
            }

            const topics = {};
            let revisionDate = null;
            let revisionTopic = '';

            for (const key in student) {
                if (key.includes('|')) {
                    const [topic, date, type] = key.split('|');
                    const topicKey = `${topic}|${date}`;

                    if(topic.toLowerCase().includes('revision')) {
                        revisionTopic = topic;
                        revisionDate = date;
                    }

                    if (!topics[topicKey]) { topics[topicKey] = { topic, date, attendance: '', degree: '' }; }
                    if (type === 'Att.') topics[topicKey].attendance = student[key];
                    if (type === 'Deg.') topics[topicKey].degree = student[key];
                }
            }

            let studentGroup = null;
            if (currentStudentList.length > 0 && revisionDate) {
                const midPoint = Math.ceil(currentStudentList.length / 2);
                const studentIndex = currentStudentList.indexOf(student['Id']);
                
                if (studentIndex !== -1) {
                    if (studentIndex < midPoint) {
                        studentGroup = 1;
                    } else {
                        studentGroup = 2;
                    }
                }
            }

            let topicCardsHtml = '';
            for(const key in topics){
                const item = topics[key];
                const isPresent = item.attendance.toUpperCase() === 'TRUE';
                const attendanceMark = isPresent ? '<span class="text-emerald-500 font-bold text-2xl">‚úì</span>' : '<span class="text-rose-500 font-bold text-2xl">‚úó</span>';
                // Refined shadow/border logic
                const borderClass = isPresent ? 'border-emerald-100' : 'border-rose-100';
                const bgClass = isPresent ? 'bg-emerald-50/50' : 'bg-rose-50/50';

                if (item.topic === 'End of Experiments') {
                    topicCardsHtml += `<div class="bg-blue-50/80 p-5 rounded-xl shadow-sm border border-blue-100 text-center col-span-1 md:col-span-2 lg:col-span-3"><h3 class="font-bold text-blue-800 text-lg">${item.topic}</h3><p class="text-sm text-blue-500 font-medium mt-1">${item.date}</p></div>`;
                } else if (item.topic.toLowerCase().includes('revision')) {
                    let displayDate = item.date;
                    let groupMessage = `Group 1`;
                    
                    if (studentGroup === 2) {
                        const [day, month, year] = item.date.split('/');
                        const originalDate = new Date(`${year}-${month}-${day}`);
                        originalDate.setDate(originalDate.getDate() + 7);
                        displayDate = originalDate.toLocaleDateString('en-GB');
                        groupMessage = `Group 2`;
                    }

                    topicCardsHtml += `
                        <div class="bg-amber-50/80 p-5 rounded-xl border border-amber-200 shadow-sm col-span-1 sm:col-span-2 lg:col-span-3">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-amber-900 text-lg">${item.topic}</h3>
                                <span class="text-xs text-amber-800 bg-amber-100 px-3 py-1 rounded-full font-bold">${displayDate}</span>
                            </div>
                            <div class="flex justify-around border-t border-amber-200/50 pt-4">
                                <div class="text-center">
                                    <p class="text-xs font-semibold text-amber-600 uppercase tracking-wide mb-1">Attendance</p>
                                    ${attendanceMark}
                                </div>
                                <div class="text-center">
                                    <p class="text-xs font-semibold text-amber-600 uppercase tracking-wide mb-1">Your Group</p>
                                    <p class="font-bold text-xl text-amber-900">${studentGroup ? groupMessage : 'N/A'}</p>
                                </div>
                            </div>
                        </div>`;
                } else {
                    topicCardsHtml += `
                    <div class="bg-white p-5 rounded-2xl border ${borderClass} shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-700 leading-snug">${item.topic}</h3>
                            <span class="text-xs font-medium text-slate-400 bg-slate-50 px-2.5 py-1 rounded-lg border border-slate-100">${item.date}</span>
                        </div>
                        <div class="flex justify-around border-t border-slate-50 pt-4">
                            <div class="text-center">
                                <p class="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-1">Status</p>
                                ${attendanceMark}
                            </div>
                            <div class="text-center">
                                <p class="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-1">Grade</p>
                                <p class="font-bold text-xl text-slate-700">${item.degree || '‚Äî'}</p>
                            </div>
                        </div>
                    </div>`;
                }
            }
            
            const resultCard = `
                <button class="back-button back-button-sticky hidden sm:block mb-6 bg-white text-slate-700 border border-slate-200 shadow-sm font-semibold px-5 py-2.5 rounded-xl hover:bg-slate-50 transition-colors">‚Üê Back to Main Board</button>
                
                <div class="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-slate-100 fade-in">
                    <h3 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                        <span class="bg-indigo-100 text-indigo-600 p-2 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                        </span>
                        Experiments & Attendance
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:col-cols-3 gap-5">${topicCardsHtml}</div>
                </div>

                <button class="back-button back-button-fab sm:hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </button>
            `;
            attendanceContent.innerHTML = resultCard;
        }

        function displayCAInfo(student) {
             if (!student) {
                 caContent.innerHTML = '<button class="back-button back-button-sticky hidden sm:block mb-4 bg-white text-slate-700 border border-slate-200 shadow-sm font-semibold px-5 py-2.5 rounded-xl hover:bg-slate-50 transition-colors">‚Üê Back to Main Board</button><div class="text-center py-10"><p class="text-slate-400 font-medium">No assessment data found.</p></div><button class="back-button back-button-fab sm:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>';
                 return;
            }

            const cards = [
                { title: 'Quiz 1', score: student['Q1/10'], max: 10, type: 'Quiz' },
                { title: 'Quiz 2', score: student['Q2/15'], max: 15, type: 'Quiz' },
                { title: 'Quiz 3', score: student['Q3/15'], max: 15, type: 'Quiz' }
            ];

            let markCardsHtml = cards.map(card => {
                const isQuiz = card.type === 'Quiz';
                const studentAccessCode = student['StudentAccessCode'];
                const hasAccessInfo = isQuiz && studentAccessCode && studentAccessCode.trim() !== '';
                
                // Enhanced card style
                const cardClasses = `bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center card-hover-effect relative overflow-hidden group ${hasAccessInfo ? 'cursor-pointer ring-2 ring-transparent hover:ring-blue-100' : ''}`;
                const dataAttributes = hasAccessInfo ? `data-id="${student['Id']}" data-code="${studentAccessCode}"` : '';
                
                // Add a "View Access" badge if available
                const badge = hasAccessInfo ? `<div class="absolute top-3 right-3 bg-blue-50 text-blue-600 p-1.5 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg></div>` : '';

                return `<div class="${cardClasses}" ${dataAttributes}>
                            ${badge}
                            ${createCircularProgressBar(card.score, card.max, card.score, card.title)}
                        </div>`;
            }).join('');
                            
            caContent.innerHTML = `
                <button class="back-button back-button-sticky hidden sm:block mb-6 bg-white text-slate-700 border border-slate-200 shadow-sm font-semibold px-5 py-2.5 rounded-xl hover:bg-slate-50 transition-colors">‚Üê Back to Main Board</button>
                
                <div class="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-slate-100 fade-in">
                    <h3 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                        <span class="bg-orange-100 text-orange-600 p-2 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        </span>
                        Quiz Performance
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">${markCardsHtml}</div>
                </div>

                <button class="back-button back-button-fab sm:hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </button>
            `;
        }

        function createCircularProgressBar(score, maxScore, displayText, title = '') {
            const scoreNum = parseFloat(score);
            const maxScoreNum = parseFloat(maxScore);
            
            let scoreColorClass = 'text-slate-700', progressBarColorClass = 'text-slate-300';
            let progressCircleHtml = '';

            if (!isNaN(scoreNum) && !isNaN(maxScoreNum) && maxScoreNum > 0) {
                const percentage = (scoreNum / maxScoreNum) * 100;
                // Updated colors for new theme
                if (percentage >= 90) { scoreColorClass = 'text-emerald-600'; progressBarColorClass = 'text-emerald-500'; }    
                else if (percentage >= 70) { scoreColorClass = 'text-lime-600'; progressBarColorClass = 'text-lime-500'; }    
                else if (percentage >= 50) { scoreColorClass = 'text-amber-500'; progressBarColorClass = 'text-amber-400'; }    
                else if (percentage >= 30) { scoreColorClass = 'text-orange-500'; progressBarColorClass = 'text-orange-400'; }    
                else { scoreColorClass = 'text-rose-500'; progressBarColorClass = 'text-rose-400'; }
                
                const radius = 40;
                const circumference = 2 * Math.PI * radius;
                const offset = circumference - (Math.min(percentage, 100) / 100) * circumference;

                progressCircleHtml = `
                    <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                        <!-- Track -->
                        <circle class="text-slate-100" stroke-width="8" stroke="currentColor" fill="transparent" r="${radius}" cx="50" cy="50"/>
                        <!-- Indicator -->
                        <circle class="${progressBarColorClass}" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="${radius}" cx="50" cy="50"    
                            style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${offset}; transition: stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1);" />
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span class="text-2xl font-bold ${scoreColorClass}">${displayText || '-'}</span>
                        <span class="text-xs font-semibold text-slate-400 mt-0.5">/ ${maxScore}</span>
                    </div>
                `;
            } else {
                progressCircleHtml = `
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span class="text-2xl font-bold text-slate-300">N/A</span>
                    </div>
                `;
            }

            const titleHtml = title ? `<p class="text-sm font-bold text-slate-600 mt-3 uppercase tracking-wide">${title}</p>` : '';

            return `
                <div class="relative w-28 h-28">
                    ${progressCircleHtml}
                </div>
                ${titleHtml}
            `;
        }

        const zipgradeModal = document.getElementById('zipgradeModal');
        const practicalReviewModal = document.getElementById('practicalReviewModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const closeReviewModalButton = document.getElementById('closeReviewModalButton');
        const modalStudentId = document.getElementById('modalStudentId');
        const modalAccessCode = document.getElementById('modalAccessCode');

        // ZipGrade Modal Logic
        function showZipgradeModal(studentId, accessCode) {
            modalStudentId.value = studentId;
            modalAccessCode.value = accessCode;
            zipgradeModal.classList.remove('hidden');
        }

        function hideZipgradeModal() {
            zipgradeModal.classList.add('hidden');
        }

        // Practical Review Modal Logic
        function showPracticalReviewModal() {
            if (!currentFinalExamStudent) return;
            
            document.getElementById('reviewExperiment').textContent = currentFinalExamStudent.experiment || '‚Äî';
            document.getElementById('reviewName').textContent = currentFinalExamStudent.reviewer || '‚Äî';
            document.getElementById('reviewDate').textContent = currentFinalExamStudent.reviewDate || '‚Äî';
            // Location is static "ŸÖÿπŸÖŸÑ 304PH" as per request/image, but we also fallback to data if valid
            const loc = currentFinalExamStudent.location || 'ŸÖÿπŸÖŸÑ 304PH';
            document.getElementById('reviewLocation').textContent = loc;
            
            practicalReviewModal.classList.remove('hidden');
        }

        function hidePracticalReviewModal() {
            practicalReviewModal.classList.add('hidden');
        }

        window.copyToClipboard = function(elementId, buttonElement) {
            const input = document.getElementById(elementId);
            input.select();
            input.setSelectionRange(0, 99999);
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(input.value).then(() => {
                        const copyText = buttonElement.querySelector('.copy-text');
                        // No explicit text change needed for icon-only button, maybe a tooltip in future
                    }).catch(err => {
                        console.error('Failed to copy: ', err);
                        fallbackCopy();
                    });
                } else {
                    fallbackCopy();
                }
                
                function fallbackCopy() {
                    document.execCommand('copy');
                }
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
            window.getSelection().removeAllRanges();
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            resultsContainer.classList.add('hidden');
        }

        function showDetailPage(type) {
            mainViewContainer.style.opacity = '0';
            setTimeout(() => {
                mainViewContainer.classList.add('hidden');
                detailsContainer.classList.remove('hidden');
                detailsContainer.style.opacity = '0';
                
                attendanceContent.classList.remove('active');
                caContent.classList.remove('active');

                if (type === 'lab') {
                    attendanceContent.classList.add('active');
                } else if (type === 'assessments') {
                    caContent.classList.add('active');
                }
                
                setTimeout(() => {
                    detailsContainer.style.opacity = '1';
                }, 10);
                
                window.scrollTo({top: 0, behavior: 'smooth'});
                
                if (window.navigator && window.navigator.vibrate) {
                    window.navigator.vibrate(5);
                }
            }, 200);
        }
        
        function hideDetailPage() {
            detailsContainer.style.opacity = '0';
            setTimeout(() => {
                mainViewContainer.classList.remove('hidden');
                detailsContainer.classList.add('hidden');
                mainViewContainer.style.opacity = '0';
                
                attendanceContent.classList.remove('active');
                caContent.classList.remove('active');
                
                setTimeout(() => {
                    mainViewContainer.style.opacity = '1';
                }, 10);
                
                window.scrollTo({top: 0, behavior: 'smooth'});
                
                if (window.navigator && window.navigator.vibrate) {
                    window.navigator.vibrate(5);
                }
            }, 200);
        }

        searchButton.addEventListener('click', findAndDisplayStudent);
        studentIdInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') findAndDisplayStudent(); });
        
        mainBoard.addEventListener('click', (event) => {
            const labCard = event.target.closest('#labScoreCardTrigger');
            const quizzesCard = event.target.closest('#quizzesCardTrigger');
            const practicalCard = event.target.closest('#practicalScoreCardTrigger'); // New trigger

            if (labCard && !labCard.classList.contains('opacity-60')) {
                showDetailPage('lab');
            } else if (quizzesCard && !quizzesCard.classList.contains('opacity-60')) {
                showDetailPage('assessments');
            } else if (practicalCard && !practicalCard.classList.contains('opacity-60')) {
                showPracticalReviewModal();
            }
        });
        
        detailsContainer.addEventListener('click', (event) => {
            if (event.target.closest('.back-button')) {
                hideDetailPage();
            }
        });

        closeModalButton.addEventListener('click', hideZipgradeModal);
        zipgradeModal.addEventListener('click', (event) => { if (event.target === zipgradeModal) hideZipgradeModal(); });

        // Practical Review Modal Listeners
        closeReviewModalButton.addEventListener('click', hidePracticalReviewModal);
        practicalReviewModal.addEventListener('click', (event) => { if (event.target === practicalReviewModal) hidePracticalReviewModal(); });

        caContent.addEventListener('click', (event) => {
            const card = event.target.closest('.quiz-card');
            if (card) {
                const studentId = card.dataset.id;
                const accessCode = card.dataset.code;
                showZipgradeModal(studentId, accessCode);
            }
        });

        // --- NEW: Header Toggle Logic for Mobile ---
        const headerToggleBtn = document.getElementById('headerToggleBtn');
        const headerDetails = document.getElementById('headerDetails');
        const headerToggleIcon = document.getElementById('headerToggleIcon');
        let isHeaderOpen = false;

        if (ENABLE_HEADER_COLLAPSE && headerToggleBtn && headerDetails && headerToggleIcon) {
            // 1. Initialize for Collapse Mode (Hide details initially on mobile)
            // We use a timeout to ensure CSS loads, or just apply classes directly
            const initCollapse = () => {
                if (window.innerWidth < 768) { // Only apply on mobile/tablet
                    headerDetails.style.maxHeight = '0px';
                    headerDetails.classList.add('opacity-0');
                    headerToggleIcon.classList.remove('hidden'); // Show arrow
                    headerToggleBtn.classList.remove('cursor-default');
                    headerToggleBtn.classList.add('cursor-pointer');
                }
            };
            initCollapse();
            // Re-check on resize
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 768) {
                    headerDetails.style.maxHeight = ''; // Reset for desktop
                    headerDetails.classList.remove('opacity-0');
                    headerToggleIcon.classList.add('hidden');
                } else if (!isHeaderOpen) {
                    headerDetails.style.maxHeight = '0px';
                    headerDetails.classList.add('opacity-0');
                    headerToggleIcon.classList.remove('hidden');
                }
            });

            // 2. Add Click Listener
            headerToggleBtn.addEventListener('click', () => {
                if (window.innerWidth >= 768) return; // Disable click on desktop

                isHeaderOpen = !isHeaderOpen;
                
                if (isHeaderOpen) {
                    // Open
                    headerDetails.style.maxHeight = headerDetails.scrollHeight + "px";
                    headerDetails.classList.remove('opacity-0');
                    headerToggleIcon.style.transform = 'rotate(180deg)';
                } else {
                    // Close
                    headerDetails.style.maxHeight = '0px';
                    headerDetails.classList.add('opacity-0');
                    headerToggleIcon.style.transform = 'rotate(0deg)';
                }
            });
        }

    </script>
</body>
</html>
