<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .attendance-tick {
            color: #10b981; /* green-500 */
            font-weight: bold;
            font-size: 1.5rem;
        }
         .attendance-cross {
            color: #ef4444; /* red-500 */
            font-weight: bold;
            font-size: 1.5rem;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Card hover effect */
        .card-hover-effect {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-hover-effect:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        /* Back Button Styles */
        .back-button-sticky {
            position: -webkit-sticky; /* For Safari */
            position: sticky;
            top: 1rem; /* 16px */
            z-index: 10;
        }
        /* Floating Action Button (FAB) for mobile */
        .back-button-fab {
            position: fixed;
            bottom: 1.5rem; /* 24px */
            right: 1.5rem; /* 24px */
            z-index: 10;
            background-color: #3b82f6; /* blue-500 */
            color: white;
            width: 3.5rem; /* 56px */
            height: 3.5rem; /* 56px */
            border-radius: 9999px; /* full */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: background-color 0.3s ease;
        }
        .back-button-fab:hover {
            background-color: #2563eb; /* blue-600 */
        }
        /* Prevent elastic scroll on body, but allow on scrollable elements */
        body {
            overscroll-behavior: none;
        }
        .scrollable-content {
            overscroll-behavior: auto;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- This container holds the main page view (header, search, main board) -->
    <div id="mainViewContainer">
        <div class="w-full max-w-5xl mx-auto p-4 md:p-6">
            
            <!-- Unified Main Content Card (Header + Search + Results) -->
            <div class="w-full bg-white rounded-xl shadow-lg p-6 md:p-8">
                <!-- Header -->
                <div class="flex items-center mb-6">
                    <div class="flex-shrink-0">
                        <img src="MUST.png" alt="MUST Logo" class="h-24 w-24 object-contain" />
                    </div>
                    <div class="ml-6 flex-grow">
                        <h1 class="text-2xl md:text-3xl font-bold" style="color: #1e3c72;">Misr University for Science and Technology</h1>
                        <p class="text-sm md:text-base mt-1" style="color: #2a5298;">Faculty of Oral and Dental Surgery — Fall 2025-2026 PHYS.101 Lab Attendance</p>
                    </div>
                </div>

                <header class="text-center mb-6 pt-6 border-t border-gray-200">
                    <h1 class="text-3xl font-bold text-gray-800">Student Portal</h1>
                    <p class="text-gray-500 mt-2">Enter your Student ID to view your details.</p>
                </header>

                <main>
                    <!-- Search Inputs -->
                    <div class="max-w-lg mx-auto flex flex-col sm:flex-row gap-4">
                        <div class="relative flex-grow">
                            <input type="text" id="studentIdInput" placeholder="Enter Student ID" class="w-full px-4 py-3 text-lg bg-gray-50 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors">
                            <button id="searchButton" class="absolute right-2 top-1/2 -translate-y-1/2 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                                Search
                            </button>
                        </div>
                    </div>

                    <!-- Loading Spinner -->
                    <div id="loading" class="text-center mt-6 hidden">
                         <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                         <p class="text-gray-500 mt-2">Fetching data...</p>
                    </div>
                    
                    <!-- Main Results Container (Main Board) -->
                    <div id="resultsContainer" class="hidden">
                        <!-- Main Board -->
                        <div id="mainBoard" class="fade-in mt-6 hidden">
                            <!-- Content will be injected by JS -->
                        </div>
                    </div>

                     <!-- Error Message -->
                    <div id="error" class="text-center mt-6 text-red-500 font-medium hidden"></div>
                </main>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="w-full text-center p-6 mt-auto">
            <p class="text-gray-600">Wishing you the best of luck in your studies!</p>
            <div class="mt-2 text-gray-500 text-sm">
                <p>Dr. Mohamed Ali</p>
                <p>Center of Basic Sciences, Physics Department</p>
                <p>+201002836484</p>
            </div>
        </footer>
    </div> <!-- End of mainViewContainer -->


    <!-- This container holds the "detail pages" -->
    <div id="detailsContainer" class="w-full max-w-5xl mx-auto p-4 md:p-6 hidden scrollable-content">
        <div>
            <div id="attendanceContent" class="tab-content">
                <!-- Attendance data will be injected here -->
            </div>
            <div id="caContent" class="tab-content">
                 <!-- C.A. data will be injected here -->
            </div>
        </div>
    </div>
    
    <!-- ZipGrade Modal -->
    <div id="zipgradeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-center fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">ZipGrade Login Info</h2>
            <p class="text-gray-500 mb-6">Use these details to log in on the ZipGrade website.</p>

            <div class="space-y-4">
                <div>
                    <label class="block text-left text-sm font-medium text-gray-500">ZipGrade Student ID</label>
                    <div class="relative mt-1">
                        <input type="text" id="modalStudentId" readonly class="w-full bg-gray-100 border border-gray-300 rounded-md px-3 py-2 text-lg">
                        <button onclick="copyToClipboard('modalStudentId', this)" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-blue-500">
                            <span class="copy-text">Copy</span>
                            <svg class="h-6 w-6 copy-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-left text-sm font-medium text-gray-500">Student Access Code</label>
                    <div class="relative mt-1">
                        <input type="text" id="modalAccessCode" readonly class="w-full bg-gray-100 border border-gray-300 rounded-md px-3 py-2 text-lg">
                         <button onclick="copyToClipboard('modalAccessCode', this)" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-blue-500">
                            <span class="copy-text">Copy</span>
                            <svg class="h-6 w-6 copy-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <a href="https://zipgrade.com/s/" target="_blank" class="mt-6 inline-block w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-colors">
                Go to ZipGrade
            </a>

            <button id="closeModalButton" class="mt-4 text-sm text-gray-500 hover:text-gray-700">Close</button>
        </div>
    </div>


    <script>
        // --- CONFIGURATION ---
        // Sheet 1: Attendance (Requires Sections)
        const GOOGLE_SHEET_1_BASE_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTTAvVKy59t4ZTV_GQPKQbUS-tchpK9OugsPXL41ScMQXsA1pDh467cksdR32pct8_bjgpOJ4NpgrZA/pub?output=csv&single=true';
        const SECTION_GIDS_1 = {
            'All': '1650908958', 'A': '1620275840', 'B': '1661871665', 'C': '804746623', 'D': '1998860796', 'E': '1432194061', 'F': '1174976610', 'G': '630589668', 'H': '340172703', 'I': '1823887500', 'J': '1811748047', 'K': '289568000', 'L': '1058769797', 'M': '672465296', 'N': '2018867860', 'O': '2510390', 'P': '1022038284', 'Q': '747459593', 'R': '1912599889', 'S': '554652905', 'T': '1568050738'
        };

        // Sheet 2: Continuous Assessment (C.A.) (One Sheet For All Students)
        const GOOGLE_SHEET_2_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSwOgvVGMBZkhsJY_dTFepiWNuK42nVXTg5ATU1jd0In027rMCC8Qx0o8Wcl7JHMxCNGtUXUMpVsiLv/pub?output=csv';

        // --- DOM ELEMENTS ---
        const studentIdInput = document.getElementById('studentIdInput');
        const searchButton = document.getElementById('searchButton');
        
        const mainViewContainer = document.getElementById('mainViewContainer');
        const detailsContainer = document.getElementById('detailsContainer');
        
        const resultsContainer = document.getElementById('resultsContainer');
        const mainBoard = document.getElementById('mainBoard'); 
        const attendanceContent = document.getElementById('attendanceContent');
        const caContent = document.getElementById('caContent');
        
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');

        // --- GLOBAL DATA VARS ---
        let currentStudentList = [];
        let fullAttendanceData = {}; // Cache for all section data
        
        // --- SWIPE DETECTION ---
        let touchstartX = 0;
        let touchendX = 0;
        const swipeThreshold = 50; // Minimum pixels for a swipe
        let touchstartY = 0;
        let touchendY = 0;

        document.body.addEventListener('touchstart', e => {
            if (!detailsContainer.classList.contains('hidden')) {
                touchstartX = e.changedTouches[0].screenX;
                touchstartY = e.changedTouches[0].screenY;
            }
        }, { passive: true });

        document.body.addEventListener('touchmove', e => {
            if (!detailsContainer.classList.contains('hidden') && touchstartX !== 0) {
                if (e.cancelable) {
                    const deltaX = e.changedTouches[0].screenX - touchstartX;
                    const deltaY = e.changedTouches[0].screenY - touchstartY;

                    // Only prevent default if it's a horizontal swipe from the edge
                    if (Math.abs(deltaX) > Math.abs(deltaY) && deltaX > 0 && touchstartX < (window.innerWidth / 10)) {
                        e.preventDefault();
                    }
                }
            }
        }, { passive: false });

        document.body.addEventListener('touchend', e => {
            if (!detailsContainer.classList.contains('hidden') && touchstartX !== 0) {
                touchendX = e.changedTouches[0].screenX;
                touchendY = e.changedTouches[0].screenY;
                handleSwipeGesture();
            }
            // Reset coordinates
            touchstartX = 0;
            touchstartY = 0;
            touchendX = 0;
            touchendY = 0;
        });


        function handleSwipeGesture() {
            const deltaX = touchendX - touchstartX;
            const deltaY = touchendY - touchstartY;

            // Check if it's a horizontal swipe that's long enough
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > swipeThreshold) {
                // Check if it's a swipe from the left edge (e.g., first 10% of screen)
                if (deltaX > 0 && touchstartX < (window.innerWidth / 10)) {
                    hideDetailPage();
                }
            }
        }

        // --- FETCH & PARSE FUNCTIONS ---
        async function fetchSheetData(baseUrl, gid) {
            const fetchUrl = `${baseUrl}&gid=${gid}`;
            const response = await fetch(fetchUrl);
            if (!response.ok) throw new Error(`Network error fetching data for GID ${gid}.`);
            return await response.text();
        }
        
        function parseAttendanceCSV(text) {
            const rows = text.split(/\r?\n/).map(row => row.split(',').map(cell => {
                let cleanCell = cell.trim();
                if (cleanCell.startsWith('"') && cleanCell.endsWith('"')) { cleanCell = cleanCell.substring(1, cleanCell.length - 1); }
                return cleanCell;
            }));
            if (rows.length < 5) return [];
            const topicRow = rows[0], dateRow = rows[1], headerRow = rows[3], dataRows = rows.slice(4);
            const structuredHeaders = [];
            let currentTopic = '', currentDate = '';
            for (let i = 0; i < headerRow.length; i++) {
                if (topicRow[i]) currentTopic = topicRow[i];
                if (dateRow[i]) currentDate = dateRow[i];
                let header = headerRow[i];
                if (i === 5) { structuredHeaders.push('Section'); continue; }
                if (header === 'Att.' || header === 'Deg.') { structuredHeaders.push(`${currentTopic}|${currentDate}|${header}`); } 
                else { structuredHeaders.push(header); }
            }
            const data = dataRows.map(row => {
                const student = {};
                structuredHeaders.forEach((header, index) => { student[header] = row[index] || ''; });
                return student;
            }).filter(student => student['Id']);
            return data;
        }

        function parseCaCSV(text) {
            const rows = text.split(/\r?\n/).map(row => row.split(',').map(cell => cell.trim()));
            if (rows.length < 6) return []; 
            const headers = rows[4]; 
            const dataRows = rows.slice(5);

            const idColumnIndex = headers.findIndex(h => h.toLowerCase().includes('id'));
            const accessCodeColumnIndex = headers.findIndex(h => h.toLowerCase().includes('access code'));
            
            if (idColumnIndex === -1) {
                console.error("Could not find a column with 'id' in the C.A. sheet's 5th row.");
                return []; 
            }
            return dataRows.map(row => {
                const student = {};
                headers.forEach((header, index) => {
                    student[header] = row[index] || '';
                });
                student['Id'] = row[idColumnIndex] || '';
                student['StudentAccessCode'] = accessCodeColumnIndex !== -1 ? row[accessCodeColumnIndex] || '' : '';
                return student;
            }).filter(student => student['Id'] && student['Id'].trim() !== '');
        }

        // --- CORE LOGIC ---
        async function findAndDisplayStudent() {
            const searchId = studentIdInput.value.trim();
            if (!searchId) { showError('Please enter a Student ID.'); return; }
            
            loadingDiv.classList.remove('hidden');
            errorDiv.classList.add('hidden');
            resultsContainer.classList.add('hidden'); 
            mainBoard.classList.add('hidden');
            
            try {
                if (GOOGLE_SHEET_2_URL.startsWith('REPLACE_WITH')) {
                    throw new Error('The Continuous Assessment sheet URL is not configured.');
                }
                
                // 1. Fetch "All" sheet to find the student and their section
                const allSheetCsv = await fetchSheetData(GOOGLE_SHEET_1_BASE_URL, SECTION_GIDS_1['All']);
                const allStudents = parseAttendanceCSV(allSheetCsv);
                const studentFromAll = allStudents.find(s => s['Id'] === searchId);

                if (!studentFromAll) {
                    showError(`No record found for Student ID: ${searchId}.`);
                    loadingDiv.classList.add('hidden');
                    return;
                }
                
                const studentSection = studentFromAll['Section'];
                const sectionGid = SECTION_GIDS_1[studentSection];
                
                if (!sectionGid) {
                    throw new Error(`Invalid or unconfigured section "${studentSection}" found for student.`);
                }

                // 2. Fetch the specific section sheet and the C.A. sheet in parallel
                const [sectionSheetCsv, caResponse] = await Promise.all([
                    fetchSheetData(GOOGLE_SHEET_1_BASE_URL, sectionGid),
                    fetch(GOOGLE_SHEET_2_URL)
                ]);

                if (!caResponse.ok) {
                    throw new Error('Network error fetching C.A. data.');
                }
                const caCsv = await caResponse.text();

                // 3. Parse all data
                const sectionAttendanceData = parseAttendanceCSV(sectionSheetCsv);
                
                // We use the specific section sheet to get the student list for revision grouping
                currentStudentList = sectionAttendanceData.map(s => s['Id']).sort();
                
                // Parse C.A. data
                const caData = parseCaCSV(caCsv);

                // 4. Find the student in all relevant datasets
                const attendanceStudent = sectionAttendanceData.find(s => s['Id'] === searchId); // Get grades from section sheet
                const caStudent = caData.find(s => s['Id'] === searchId);
                
                attendanceContent.innerHTML = '';
                caContent.innerHTML = '';
                mainBoard.innerHTML = '';

                // 5. Display data
                displayMainBoard(attendanceStudent, caStudent, studentSection);
                displayAttendanceInfo(attendanceStudent); // This will use currentStudentList for grouping
                displayCAInfo(caStudent); 
                
                mainViewContainer.classList.remove('hidden');
                resultsContainer.classList.remove('hidden');
                mainBoard.classList.remove('hidden');
                detailsContainer.classList.add('hidden');

            } catch (error) {
                console.error('Error during search:', error);
                showError(error.message || 'Could not load student data. Please check configurations and connection.');
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }
        
        // --- DISPLAY FUNCTIONS ---

        function displayMainBoard(attendanceStudent, caStudent, studentSection) {
            // Get Info
            const studentName = attendanceStudent ? attendanceStudent['Name'] : (caStudent ? caStudent['Name'] : 'N/A');
            const studentId = attendanceStudent ? attendanceStudent['Id'] : (caStudent ? caStudent['Id'] : 'N/A');

            // Get Lab Score from attendanceStudent
            const labScore = attendanceStudent ? attendanceStudent['Total'] : 'N/A';

            // Get Grades from caStudent
            const quiz1 = caStudent ? parseFloat(caStudent['Q1/10'] || 0) : 0;
            const quiz2 = caStudent ? parseFloat(caStudent['Q2/15'] || 0) : 0;
            const quiz3 = caStudent ? parseFloat(caStudent['Q3/15'] || 0) : 0;
            const quizTotal = quiz1 + quiz2 + quiz3;
            const practicalScore = caStudent ? caStudent['pra'] : 'N/A';
            const totalScore = caStudent ? caStudent['Total'] : 'N/A';
            const rank = caStudent ? caStudent['Rank'] : 'N/A';

            // Create Progress Circles
            const quizCircle = caStudent ? createCircularProgressBar(quizTotal, 40, quizTotal.toFixed(1), 'Quizzes') : createCircularProgressBar(0, 40, 'N/A', 'Quizzes');
            const labScoreCircle = attendanceStudent ? createCircularProgressBar(labScore, 10, labScore, 'Lab Score') : createCircularProgressBar(0, 10, 'N/A', 'Lab Score');
            const practicalCircle = caStudent ? createCircularProgressBar(practicalScore, 20, practicalScore, 'Final Practical') : createCircularProgressBar(0, 20, 'N/A', 'Final Practical');
            
            // Total Score & Rank HTML
            const totalScoreHtml = caStudent ? `<p class="text-4xl font-bold text-indigo-600">${totalScore} / 70</p>` : '';
            const rankHtml = caStudent ? `<p class="text-lg font-semibold text-gray-600 flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>Rank: <span class="text-2xl text-amber-500">${rank}</span></p>` : '';


            const mainBoardHtml = `
                <div class="mb-4 text-center md:text-left">
                    <h2 class="text-2xl font-bold text-gray-800">${studentName}</h2>
                    <p class="text-gray-500">Student ID: ${studentId}</p>
                    <p class="text-gray-500 mt-1">Section: ${studentSection || 'N/A'}</p>
                </div>
                <div class="text-center mb-6 pt-6 border-t"><h3 class="text-xl font-bold text-gray-700">Total Score & Rank</h3><div class="flex flex-wrap items-center justify-center gap-4 sm:gap-8 mt-2">${totalScoreHtml}${rankHtml}</div></div>
                <h3 class="text-xl font-bold text-gray-700 mb-4 mt-6 pt-6 border-t text-center">Main Grades</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div id="quizzesCardTrigger" class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200 flex flex-col items-center card-hover-effect ${caStudent ? 'cursor-pointer' : 'opacity-50'}">
                        ${quizCircle}
                    </div>
                    <div id="labScoreCardTrigger" class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200 flex flex-col items-center card-hover-effect ${attendanceStudent ? 'cursor-pointer' : 'opacity-50'}">
                        ${labScoreCircle}
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200 flex flex-col items-center card-hover-effect opacity-50">
                        ${practicalCircle}
                    </div>
                </div>
            `;
            mainBoard.innerHTML = mainBoardHtml;
        }

        function displayAttendanceInfo(student) {
            if (!student) {
                 attendanceContent.innerHTML = '<button class="back-button back-button-sticky hidden sm:block mb-4 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors">← Back to Main Board</button><p class="text-center text-gray-500">No lab data found for this student.</p><button class="back-button back-button-fab sm:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>';
                 return;
            }

            const topics = {};
            let revisionDate = null;
            let revisionTopic = '';

            for (const key in student) {
                if (key.includes('|')) {
                    const [topic, date, type] = key.split('|');
                    const topicKey = `${topic}|${date}`;

                    if(topic.toLowerCase().includes('revision')) {
                        revisionTopic = topic;
                        revisionDate = date; // Store this for later
                    }

                    if (!topics[topicKey]) { topics[topicKey] = { topic, date, attendance: '', degree: '' }; }
                    if (type === 'Att.') topics[topicKey].attendance = student[key];
                    if (type === 'Deg.') topics[topicKey].degree = student[key];
                }
            }

            // --- Revision Group Logic ---
            let studentGroup = null;
            if (currentStudentList.length > 0 && revisionDate) {
                // currentStudentList is already the sorted list from the specific section
                const midPoint = Math.ceil(currentStudentList.length / 2);
                const studentIndex = currentStudentList.indexOf(student['Id']);
                
                if (studentIndex !== -1) {
                    if (studentIndex < midPoint) {
                        studentGroup = 1; // Belongs to first group
                    } else {
                        studentGroup = 2; // Belongs to second group
                    }
                }
            }

            let topicCardsHtml = '';
            for(const key in topics){
                const item = topics[key];
                const isPresent = item.attendance.toUpperCase() === 'TRUE';
                const attendanceMark = isPresent ? '<span class="attendance-tick">✓</span>' : '<span class="attendance-cross">✗</span>';
                const shadowClass = isPresent ? 'shadow-lg shadow-green-200/60' : 'shadow-lg shadow-red-200/60';

                if (item.topic === 'End of Experiments') {
                    topicCardsHtml += `<div class="bg-blue-50 p-4 rounded-lg shadow-sm border border-blue-200 text-center col-span-1 md:col-span-2 lg:col-span-3"><h3 class="font-semibold text-blue-800">${item.topic}</h3><p class="text-sm text-blue-600">${item.date}</p></div>`;
                } else if (item.topic.toLowerCase().includes('revision')) {
                    // Revision Logic
                    let displayDate = item.date;
                    let groupMessage = `Group 1`;
                    
                    if (studentGroup === 2) {
                        // Calculate next week's date
                        const [day, month, year] = item.date.split('/');
                        const originalDate = new Date(`${year}-${month}-${day}`);
                        originalDate.setDate(originalDate.getDate() + 7); // Add 7 days
                        displayDate = originalDate.toLocaleDateString('en-GB'); // Format as DD/MM/YYYY
                        groupMessage = `Group 2`;
                    }

                    topicCardsHtml += `
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 transition-shadow duration-300 ${shadowClass} col-span-1 sm:col-span-2 lg:col-span-3">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-semibold text-yellow-800">${item.topic}</h3>
                                <span class="text-xs text-yellow-700 bg-yellow-100 px-2 py-1 rounded-full font-medium">${displayDate}</span>
                            </div>
                            <div class="flex justify-around border-t border-yellow-200 pt-3 mt-3">
                                <div class="text-center">
                                    <p class="text-sm text-yellow-600 mb-1">Attendance</p>
                                    ${attendanceMark}
                                </div>
                                <div class="text-center">
                                    <p class="text-sm text-yellow-600 mb-1">Your Group</p>
                                    <p class="font-bold text-xl text-yellow-800">${studentGroup ? groupMessage : 'N/A'}</p>
                                </div>
                            </div>
                        </div>`;
                } else {
                    topicCardsHtml += `<div class="bg-white p-4 rounded-lg border border-gray-200 transition-shadow duration-300 ${shadowClass}"><div class="flex justify-between items-center mb-3"><h3 class="font-semibold text-gray-800">${item.topic}</h3><span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">${item.date}</span></div><div class="flex justify-around border-t pt-3 mt-3"><div class="text-center"><p class="text-sm text-gray-500 mb-1">Attendance</p>${attendanceMark}</div><div class="text-center"><p class="text-sm text-gray-500 mb-1">Degree</p><p class="font-bold text-xl text-gray-700">${item.degree || '—'}</p></div></div></div>`;
                }
            }
            
            const resultCard = `
                <!-- Desktop back button -->
                <button class="back-button back-button-sticky hidden sm:block mb-4 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors">← Back to Main Board</button>
                
                <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg fade-in mt-4 sm:mt-0">
                    <h3 class="text-xl font-bold text-gray-700 mb-4">Experiments & Attendance</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:col-cols-3 gap-4">${topicCardsHtml}</div>
                </div>

                <!-- Mobile FAB back button -->
                <button class="back-button back-button-fab sm:hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </button>
            `;
            attendanceContent.innerHTML = resultCard;
        }

        function displayCAInfo(student) {
             if (!student) {
                 caContent.innerHTML = '<button class="back-button back-button-sticky hidden sm:block mb-4 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors">← Back to Main Board</button><p class="text-center text-gray-500">No assessment data found for this student.</p><button class="back-button back-button-fab sm:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>';
                 return;
            }

            const cards = [
                { title: 'Quiz 1', score: student['Q1/10'], max: 10, type: 'Quiz' },
                { title: 'Quiz 2', score: student['Q2/15'], max: 15, type: 'Quiz' },
                { title: 'Quiz 3', score: student['Q3/15'], max: 15, type: 'Quiz' }
            ];

            let markCardsHtml = cards.map(card => {
                const isQuiz = card.type === 'Quiz';
                const studentAccessCode = student['StudentAccessCode'];
                const hasAccessInfo = isQuiz && studentAccessCode && studentAccessCode.trim() !== '';
                
                const cardClasses = `bg-gradient-to-br from-white to-gray-50 p-4 rounded-lg shadow-sm border border-gray-200 flex flex-col items-center card-hover-effect ${hasAccessInfo ? 'cursor-pointer quiz-card' : ''}`;
                const dataAttributes = hasAccessInfo ? `data-id="${student['Id']}" data-code="${studentAccessCode}"` : '';

                return `<div class="${cardClasses}" ${dataAttributes}>
                            ${createCircularProgressBar(card.score, card.max, card.score, card.title)}
                        </div>`;
            }).join('');
                        
            caContent.innerHTML = `
                <!-- Desktop back button -->
                <button class="back-button back-button-sticky hidden sm:block mb-4 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors">← Back to Main Board</button>
                
                <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg fade-in mt-4 sm:mt-0">
                    <h3 class="text-xl font-bold text-gray-700 mb-4">Quiz Details</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">${markCardsHtml}</div>
                </div>

                <!-- Mobile FAB back button -->
                <button class="back-button back-button-fab sm:hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </button>
            `;
        }

        function createCircularProgressBar(score, maxScore, displayText, title = '') {
            const scoreNum = parseFloat(score);
            const maxScoreNum = parseFloat(maxScore);
            
            let scoreColorClass = 'text-gray-700', progressBarColorClass = 'text-gray-400';
            let progressCircleHtml = '';

            if (!isNaN(scoreNum) && !isNaN(maxScoreNum) && maxScoreNum > 0) {
                const percentage = (scoreNum / maxScoreNum) * 100;
                if (percentage >= 90) { scoreColorClass = 'text-green-600'; progressBarColorClass = 'text-green-600'; } 
                else if (percentage >= 70) { scoreColorClass = 'text-lime-500'; progressBarColorClass = 'text-lime-500'; } 
                else if (percentage >= 50) { scoreColorClass = 'text-yellow-400'; progressBarColorClass = 'text-yellow-400'; } 
                else if (percentage >= 30) { scoreColorClass = 'text-orange-500'; progressBarColorClass = 'text-orange-500'; } 
                else { scoreColorClass = 'text-red-600'; progressBarColorClass = 'text-red-600'; }
                
                const radius = 40;
                const circumference = 2 * Math.PI * radius;
                const offset = circumference - (Math.min(percentage, 100) / 100) * circumference;

                progressCircleHtml = `
                    <svg class="w-full h-full" viewBox="0 0 100 100">
                        <circle class="text-gray-200" stroke-width="10" stroke="currentColor" fill="transparent" r="${radius}" cx="50" cy="50"/>
                        <circle class="${progressBarColorClass}" stroke-width="10" stroke-linecap="round" stroke="currentColor" fill="transparent" r="${radius}" cx="50" cy="50" 
                            style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${offset}; transition: stroke-dashoffset 0.5s ease 0s; transform: rotate(-90deg); transform-origin: 50% 50%;" />
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span class="text-3xl font-bold ${scoreColorClass}">${displayText || 'N/A'}</span>
                        <span class="text-sm text-gray-500">/ ${maxScore}</span>
                    </div>
                `;
            } else {
                // Fallback for N/A or invalid data
                progressCircleHtml = `
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span class="text-3xl font-bold text-gray-700">${displayText || 'N/A'}</span>
                    </div>
                `;
            }

            const titleHtml = title ? `<p class="text-base font-bold text-gray-700 mt-2">${title}</p>` : '';

            return `
                <div class="relative w-32 h-32 mt-2">
                    ${progressCircleHtml}
                </div>
                ${titleHtml}
            `;
        }


        // --- UTILITY & MODAL FUNCTIONS ---
        const zipgradeModal = document.getElementById('zipgradeModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const modalStudentId = document.getElementById('modalStudentId');
        const modalAccessCode = document.getElementById('modalAccessCode');

        function showZipgradeModal(studentId, accessCode) {
            modalStudentId.value = studentId;
            modalAccessCode.value = accessCode;
            zipgradeModal.classList.remove('hidden');
        }

        function hideZipgradeModal() {
            zipgradeModal.classList.add('hidden');
        }

        window.copyToClipboard = function(elementId, buttonElement) {
            const input = document.getElementById(elementId);
            input.select();
            input.setSelectionRange(0, 99999); // For mobile devices
            try {
                // Use execCommand as a fallback for iframe environments
                document.execCommand('copy');
                const copyText = buttonElement.querySelector('.copy-text');
                if(copyText) {
                    copyText.textContent = 'Copied!';
                    setTimeout(() => { copyText.textContent = 'Copy'; }, 2000);
                }
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
            window.getSelection().removeAllRanges(); // Deselect
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            resultsContainer.classList.add('hidden');
        }

        function showDetailPage(type) {
            // Hide main view, show detail view
            mainViewContainer.classList.add('hidden');
            detailsContainer.classList.remove('hidden');
            
            // Hide all detail content first
            attendanceContent.classList.remove('active');
            caContent.classList.remove('active');

            if (type === 'lab') {
                attendanceContent.classList.add('active');
            } else if (type === 'assessments') {
                caContent.classList.add('active');
            }
             window.scrollTo(0, 0); // Scroll to top
        }
        
        function hideDetailPage() {
            // Hide detail view, show main view
            mainViewContainer.classList.remove('hidden');
            detailsContainer.classList.add('hidden');
            
            // Hide all detail content
            attendanceContent.classList.remove('active');
            caContent.classList.remove('active');
             window.scrollTo(0, 0); // Scroll to top
        }

        // --- EVENT LISTENERS ---
        searchButton.addEventListener('click', findAndDisplayStudent);
        studentIdInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') findAndDisplayStudent(); });
        
        // Event listeners for the new clickable cards on the Main Board
        mainBoard.addEventListener('click', (event) => {
            const labCard = event.target.closest('#labScoreCardTrigger');
            const quizzesCard = event.target.closest('#quizzesCardTrigger');

            if (labCard && !labCard.classList.contains('opacity-50')) {
                showDetailPage('lab');
            } else if (quizzesCard && !quizzesCard.classList.contains('opacity-50')) {
                showDetailPage('assessments');
            }
        });
        
        // Event listener for the "Back" buttons
        detailsContainer.addEventListener('click', (event) => {
            if (event.target.closest('.back-button')) {
                hideDetailPage();
            }
        });

        closeModalButton.addEventListener('click', hideZipgradeModal);
        zipgradeModal.addEventListener('click', (event) => { if (event.target === zipgradeModal) hideZipgradeModal(); });

        caContent.addEventListener('click', (event) => {
            const card = event.target.closest('.quiz-card');
            if (card) {
                const studentId = card.dataset.id;
                const accessCode = card.dataset.code;
                showZipgradeModal(studentId, accessCode);
            }
        });

    </script>
</body>
</html>
