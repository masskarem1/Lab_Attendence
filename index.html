<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Cairo Font for Arabic support -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }
        /* Apply Cairo font specifically to Arabic text areas if needed, or generally */
        .font-arabic {
            font-family: 'Cairo', 'Inter', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* New Animation for Congrats Modal */
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop-in {
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .attendance-tick {
            color: #10b981;
            font-weight: bold;
            font-size: 1.5rem;
        }
         .attendance-cross {
            color: #ef4444;
            font-weight: bold;
            font-size: 1.5rem;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .card-hover-effect {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        .card-hover-effect:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .card-hover-effect:active {
            transform: scale(0.98);
            box-shadow: 0 2px 4px -1px rgb(0 0 0 / 0.1);
        }
        .back-button-sticky {
            position: -webkit-sticky;
            position: sticky;
            top: 1rem;
            z-index: 10;
        }
        .back-button-fab {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 50;
            background-color: #3b82f6;
            color: white;
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 16px -4px rgb(0 0 0 / 0.3), 0 4px 8px -2px rgb(0 0 0 / 0.2);
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }
        .back-button-fab:active {
            transform: scale(0.95);
            background-color: #2563eb;
        }
        body {
            overscroll-behavior: none;
        }
        .scrollable-content {
            overscroll-behavior: auto;
        }
        html, body {
            overscroll-behavior-y: contain;
        }
        .scrollable-content {
            -webkit-overflow-scrolling: touch;
        }
        input[type="text"] {
            font-size: 16px;
        }
        #mainViewContainer, #detailsContainer {
            transition: opacity 0.2s ease;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        /* Global button click effect (keeps other buttons interactive) */
        button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        /* STRICT OVERRIDE: Remove all animation/scaling from the Search button */
        #searchButton {
            transform: none !important;
            transition: none !important;
        }
        #searchButton:active {
            transform: none !important;
            opacity: 1 !important;
        }

        #zipgradeModal .bg-white, #practicalReviewModal .bg-white {
            max-height: 90vh;
            overflow-y: auto;
        }
        @media (max-width: 640px) {
            .card-hover-effect {
                position: relative;
                overflow: hidden;
            }
            .card-hover-effect::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                border-radius: 50%;
                background: rgba(59, 130, 246, 0.1);
                transform: translate(-50%, -50%);
                transition: width 0.4s, height 0.4s;
            }
            .card-hover-effect:active::before {
                width: 300px;
                height: 300px;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="mainViewContainer">
        <div class="w-full max-w-5xl mx-auto p-4 md:p-6">
            
            <div class="w-full bg-white rounded-xl shadow-lg p-6 md:p-8">
                <div class="flex items-center mb-6">
                    <div class="flex-shrink-0">
                        <img src="MUST.png" alt="MUST Logo" class="h-24 w-24 object-contain" onerror="this.src='https://placehold.co/100x100/1e3c72/FFFFFF?text=MUST&font=inter'"/>
                    </div>
                    <div class="ml-6 flex-grow">
                        <h1 class="text-2xl md:text-3xl font-bold" style="color: #1e3c72;">Misr University for Science and Technology</h1>
                        <p class="text-sm md:text-base mt-1" style="color: #2a5298;">Faculty of Oral and Dental Surgery ‚Äî Fall 2025-2026 PHYS.101 Lab Attendance</p>
                    </div>
                </div>

                <header class="text-center mb-6 pt-6 border-t border-gray-200">
                    <h1 class="text-3xl font-bold text-gray-800">Student Portal</h1>
                    <p class="text-gray-500 mt-2">Enter your Student ID to view your details.</p>
                </header>

                <main>
                    <div class="max-w-lg mx-auto flex flex-col sm:flex-row gap-4">
                        <div class="relative flex-grow">
                            <input type="text" id="studentIdInput" placeholder="Enter Student ID" class="w-full px-4 py-3 text-lg bg-gray-50 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors">
                            <button id="searchButton" class="absolute right-2 top-1/2 -translate-y-1/2 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                                Search
                            </button>
                        </div>
                    </div>

                    <div id="loading" class="text-center mt-6 hidden">
                         <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                         <p class="text-gray-500 mt-2">Fetching data...</p>
                    </div>
                    
                    <div id="resultsContainer" class="hidden">
                        <div id="mainBoard" class="fade-in mt-6 hidden">
                        </div>
                    </div>

                     <div id="error" class="text-center mt-6 text-red-500 font-medium hidden"></div>
                </main>
            </div>
        </div>
        
        <footer class="w-full text-center p-6 mt-auto">
            <p class="text-gray-600">Wishing you the best of luck in your studies!</p>
            <div class="mt-2 text-gray-500 text-sm">
                <p>Dr. Mohamed Ali</p>
                <p>Center of Basic Sciences, Physics Department</p>
                <p>+201002836484</p>
            </div>
        </footer>
    </div>

    <div id="detailsContainer" class="w-full max-w-5xl mx-auto p-4 md:p-6 hidden scrollable-content">
        <div>
            <div id="attendanceContent" class="tab-content">
            </div>
            <div id="caContent" class="tab-content">
            </div>
        </div>
    </div>
    
    <!-- ZipGrade Modal -->
    <div id="zipgradeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-center fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">ZipGrade Login Info</h2>
            <p class="text-gray-500 mb-6">Use these details to log in on the ZipGrade website.</p>

            <div class="space-y-4">
                <div>
                    <label class="block text-left text-sm font-medium text-gray-500">ZipGrade Student ID</label>
                    <div class="relative mt-1">
                        <input type="text" id="modalStudentId" readonly class="w-full bg-gray-100 border border-gray-300 rounded-md px-3 py-2 text-lg">
                        <button onclick="copyToClipboard('modalStudentId', this)" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-blue-500">
                            <span class="copy-text">Copy</span>
                            <svg class="h-6 w-6 copy-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-left text-sm font-medium text-gray-500">Student Access Code</label>
                    <div class="relative mt-1">
                        <input type="text" id="modalAccessCode" readonly class="w-full bg-gray-100 border border-gray-300 rounded-md px-3 py-2 text-lg">
                         <button onclick="copyToClipboard('modalAccessCode', this)" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-blue-500">
                            <span class="copy-text">Copy</span>
                            <svg class="h-6 w-6 copy-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <a href="https://zipgrade.com/s/" target="_blank" class="mt-6 inline-block w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-colors">
                Go to ZipGrade
            </a>

            <button id="closeModalButton" class="mt-4 text-sm text-gray-500 hover:text-gray-700">Close</button>
        </div>
    </div>

    <!-- Practical Review Modal (Refined for One-Line Fit on Mobile) -->
    <div id="practicalReviewModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden font-arabic">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md fade-in relative overflow-hidden">
            <!-- Decorative circle -->
            <div class="absolute -top-10 -left-10 w-24 h-24 bg-yellow-100 rounded-full blur-xl opacity-50"></div>
            
            <!-- Header -->
            <div class="flex flex-col items-center justify-center border-b pb-4 mb-4" dir="rtl">
                 <div class="flex items-center gap-2 mb-2 w-full justify-center">
                    <span class="text-2xl sm:text-3xl">üîî</span>
                    <!-- Title resized and forced to one line -->
                    <h2 class="text-base sm:text-xl font-bold text-gray-800 whitespace-nowrap">ÿ™ŸÜŸàŸäŸá ŸáÿßŸÖ: ŸÖÿ±ÿßÿ¨ÿπÿ© ÿ™ÿµÿ≠Ÿäÿ≠ ÿßŸÑÿπŸÖŸÑŸä</h2>
                 </div>
                 <p class="text-gray-600 text-center leading-relaxed text-sm sm:text-base">
                    ŸäŸÖŸÉŸÜŸÉŸÖ ŸÖÿ±ÿßÿ¨ÿπÿ© Ÿàÿ™ÿØŸÇŸäŸÇ ÿ™ÿµÿ≠Ÿäÿ≠ ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿπŸÖŸÑŸä ŸÖŸÜ ÿßŸÑŸÖŸÇÿ±ÿ±.
                </p>
            </div>

            <!-- Details Table (Table Layout - LTR & English Labels) -->
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-100 mb-6 overflow-hidden">
                <!-- Text size reduced to text-xs on mobile to ensure single line fit -->
                <table class="w-full text-left text-xs sm:text-base">
                    <tbody>
                        <tr class="border-b border-gray-200 last:border-0">
                            <td class="py-2 font-bold text-gray-700 whitespace-nowrap pr-2 w-auto">Experiment:</td>
                            <td class="py-2 text-gray-900 font-semibold whitespace-nowrap" id="reviewExperiment"></td>
                        </tr>
                        <tr class="border-b border-gray-200 last:border-0">
                            <td class="py-2 font-bold text-gray-700 whitespace-nowrap pr-2">Reviewer:</td>
                            <td class="py-2 text-gray-900 font-semibold whitespace-nowrap" id="reviewName"></td>
                        </tr>
                        <tr class="border-b border-gray-200 last:border-0">
                            <td class="py-2 font-bold text-gray-700 whitespace-nowrap pr-2">Location:</td>
                            <td class="py-2 text-gray-900 font-semibold whitespace-nowrap" id="reviewLocation">304 LB PH</td>
                        </tr>
                        <tr class="last:border-0">
                            <td class="py-2 font-bold text-gray-700 whitespace-nowrap pr-2 align-top">Date:</td>
                            <td class="py-2 text-gray-900 font-semibold whitespace-nowrap" id="reviewDate"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <p class="text-xs sm:text-sm text-red-500 font-bold mb-6 text-center" dir="rtl">
                 ŸÖŸÑÿßÿ≠ÿ∏ÿ©: Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ŸÅŸä ÿßŸÑŸÖŸàÿπÿØ ÿßŸÑŸÖÿ≠ÿØÿØ ŸÑÿ•ŸÜŸáÿßÿ° ÿπŸÖŸÑŸäÿ© ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ© ŸàŸÑŸÜ Ÿäÿ≠ŸÇ ŸÑŸÉ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ© ŸÅŸä ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿÆŸÑŸÅ ÿπŸÜ ÿßŸÑŸÖŸàÿπÿØ ÿßŸÑŸÖÿ≠ÿØÿØ.
            </p>

            <button id="closeReviewModalButton" class="w-full bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-gray-300 transition-colors">
                ÿ•ÿ∫ŸÑÿßŸÇ
            </button>
        </div>
    </div>

    <!-- Congratulations Modal (Updated for Game Style Transparency) -->
    <div id="congratsModal" class="fixed inset-0 bg-black bg-opacity-85 flex items-center justify-center p-4 z-[60] hidden">
        <div class="w-full max-w-sm text-center relative animate-pop-in">
            <!-- Decorative Glow Behind Trophy -->
            <div id="congratsBgGradient" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-yellow-500 rounded-full blur-3xl opacity-40 -z-10"></div>
            
            <div class="relative z-10 flex flex-col items-center">
                <!-- Icon with bounce animation -->
                <div id="congratsIcon" class="text-8xl mb-6 animate-bounce drop-shadow-2xl">üèÜ</div>
                
                <h2 id="congratsTitle" class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 mb-2 drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)] filter">
                    Congratulations!
                </h2>
                
                <p id="congratsRankMsg" class="text-2xl font-bold text-white mb-2 drop-shadow-md">
                    You are Ranked #1!
                </p>
                
                <p class="text-gray-200 mb-8 text-lg font-medium drop-shadow-sm">
                    Outstanding performance.<br>Keep up the amazing work!
                </p>
                
                <button id="congratsButton" onclick="closeCongratsModal()" class="bg-gradient-to-b from-yellow-400 to-orange-600 border-b-4 border-orange-800 text-white font-bold py-3 px-10 rounded-full shadow-lg transform transition active:scale-95 active:border-b-0 active:translate-y-1 hover:brightness-110">
                    Awesome!
                </button>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_SHEET_1_BASE_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTTAvVKy59t4ZTV_GQPKQbUS-tchpK9OugsPXL41ScMQXsA1pDh467cksdR32pct8_bjgpOJ4NpgrZA/pub?output=csv&single=true';
        const FINAL_EXAM_GID = '1063209357';
        
        const SECTION_GIDS_1 = {
            'All': '1650908958', 'A': '1620275840', 'B': '1661871665', 'C': '804746623', 'D': '1998860796', 'E': '1432194061', 'F': '1174976610', 'G': '630589668', 'H': '340172703', 'I': '1823887500', 'J': '1811748047', 'K': '289568000', 'L': '1058769797', 'M': '672465296', 'N': '2018867860', 'O': '2510390', 'P': '1022038284', 'Q': '747459593', 'R': '1912599889', 'S': '554652905', 'T': '1568050738'
        };

        const GOOGLE_SHEET_2_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSwOgvVGMBZkhsJY_dTFepiWNuK42nVXTg5ATU1jd0In027rMCC8Qx0o8Wcl7JHMxCNGtUXUMpVsiLv/pub?output=csv';

        const studentIdInput = document.getElementById('studentIdInput');
        const searchButton = document.getElementById('searchButton');
        
        const mainViewContainer = document.getElementById('mainViewContainer');
        const detailsContainer = document.getElementById('detailsContainer');
        
        const resultsContainer = document.getElementById('resultsContainer');
        const mainBoard = document.getElementById('mainBoard');    
        const attendanceContent = document.getElementById('attendanceContent');
        const caContent = document.getElementById('caContent');
        
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');

        let currentStudentList = [];
        let fullAttendanceData = {};
        let currentFinalExamStudent = null; // Store for modal access
        
        let touchstartX = 0;
        let touchendX = 0;
        const swipeThreshold = 80;
        let touchstartY = 0;
        let touchendY = 0;
        let isScrolling = null;
        let swipeHandled = false;

        document.body.addEventListener('touchstart', e => {
            if (!detailsContainer.classList.contains('hidden')) {
                touchstartX = e.changedTouches[0].screenX;
                touchstartY = e.changedTouches[0].screenY;
                isScrolling = null;
                swipeHandled = false;
                
                const fab = document.querySelector('.back-button-fab');
                if (fab && touchstartX < (window.innerWidth / 8)) {
                    fab.style.transform = 'scale(1.1)';
                }
            }
        }, { passive: true });

        document.body.addEventListener('touchmove', e => {
            if (!detailsContainer.classList.contains('hidden') && touchstartX !== 0) {
                const deltaX = e.changedTouches[0].screenX - touchstartX;
                const deltaY = e.changedTouches[0].screenY - touchstartY;

                if (isScrolling === null) {
                    isScrolling = Math.abs(deltaY) > Math.abs(deltaX);
                }

                if (!isScrolling && deltaX > 0 && touchstartX < (window.innerWidth / 8)) {
                    if (e.cancelable) {
                        e.preventDefault();
                    }
                    
                    swipeHandled = true;
                    
                    const progress = Math.min(deltaX / 150, 1);
                    detailsContainer.style.opacity = 1 - (progress * 0.3);
                    detailsContainer.style.transform = `translateX(${deltaX * 0.5}px)`;
                }
            }
        }, { passive: false });

        document.body.addEventListener('touchend', e => {
            if (!detailsContainer.classList.contains('hidden') && touchstartX !== 0) {
                touchendX = e.changedTouches[0].screenX;
                touchendY = e.changedTouches[0].screenY;
                
                if (swipeHandled) {
                    handleSwipeGesture(e); // Pass the event object
                }
                
                detailsContainer.style.opacity = '1';
                detailsContainer.style.transform = 'translateX(0)';
                const fab = document.querySelector('.back-button-fab');
                if (fab) fab.style.transform = 'scale(1)';
            }
            touchstartX = 0;
            touchstartY = 0;
            touchendX = 0;
            touchendY = 0;
            isScrolling = null;
            swipeHandled = false;
        });

        function handleSwipeGesture(event) {
            const deltaX = touchendX - touchstartX;
            const deltaY = touchendY - touchstartY;

            if (Math.abs(deltaX) > Math.abs(deltaY) && deltaX > swipeThreshold) {
                if (touchstartX < (window.innerWidth / 8)) {
                    if (event) { // Check if event exists
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    
                    hideDetailPage();
                    
                    if (window.navigator && window.navigator.vibrate) {
                        window.navigator.vibrate(10);
                    }
                }
            }
        }

        async function fetchSheetData(baseUrl, gid) {
            const fetchUrl = `${baseUrl}&gid=${gid}`;
            const response = await fetch(fetchUrl);
            if (!response.ok) throw new Error(`Network error fetching data for GID ${gid}.`);
            return await response.text();
        }
        
        function parseAttendanceCSV(text) {
            const rows = text.split(/\r?\n/).map(row => row.split(',').map(cell => {
                let cleanCell = cell.trim();
                if (cleanCell.startsWith('"') && cleanCell.endsWith('"')) { cleanCell = cleanCell.substring(1, cleanCell.length - 1); }
                return cleanCell;
            }));
            if (rows.length < 5) return [];
            const topicRow = rows[0], dateRow = rows[1], headerRow = rows[3], dataRows = rows.slice(4);
            const structuredHeaders = [];
            let currentTopic = '', currentDate = '';
            for (let i = 0; i < headerRow.length; i++) {
                if (topicRow[i]) currentTopic = topicRow[i];
                if (dateRow[i]) currentDate = dateRow[i];
                let header = headerRow[i];
                if (i === 5) { structuredHeaders.push('Section'); continue; }
                if (header === 'Att.' || header === 'Deg.') { structuredHeaders.push(`${currentTopic}|${currentDate}|${header}`); }    
                else { structuredHeaders.push(header); }
            }
            const data = dataRows.map(row => {
                const student = {};
                structuredHeaders.forEach((header, index) => { student[header] = row[index] || ''; });
                return student;
            }).filter(student => student['Id']);
            return data;
        }

        function parseCaCSV(text) {
            const rows = text.split(/\r?\n/).map(row => row.split(',').map(cell => cell.trim()));
            if (rows.length < 6) return [];    
            const headers = rows[4];    
            const dataRows = rows.slice(5);

            const idColumnIndex = headers.findIndex(h => h.toLowerCase().includes('id'));
            const accessCodeColumnIndex = headers.findIndex(h => h.toLowerCase().includes('access code'));
            
            if (idColumnIndex === -1) {
                console.error("Could not find a column with 'id' in the C.A. sheet's 5th row.");
                return [];    
            }
            return dataRows.map(row => {
                const student = {};
                headers.forEach((header, index) => {
                    student[header] = row[index] || '';
                });
                student['Id'] = row[idColumnIndex] || '';
                student['StudentAccessCode'] = accessCodeColumnIndex !== -1 ? row[accessCodeColumnIndex] || '' : '';
                return student;
            }).filter(student => student['Id'] && student['Id'].trim() !== '');
        }

        // --- FUNCTION TO PARSE FINAL EXAM DATA ---
        function parseFinalExamCSV(text) {
             const rows = text.split(/\r?\n/).map(row => row.split(',').map(cell => {
                let cleanCell = cell.trim();
                if (cleanCell.startsWith('"') && cleanCell.endsWith('"')) {
                     cleanCell = cleanCell.substring(1, cleanCell.length - 1);
                }
                return cleanCell;
            }));
            
            if (rows.length < 2) return [];

            const dataRows = rows.slice(1);

            return dataRows.map(row => {
                return {
                    id: row[1] || '',
                    day: row[4] || '',
                    time: row[5] || '',
                    date: row[6] || '',
                    location: row[7] || '',
                    experiment: row[8] || '', // Column I (index 8) - ÿßŸÑÿ™ÿ¨ÿ±ÿ®ÿ©
                    reviewer: row[12] || '',  // Column M (index 12) - ÿßŸÑŸÖÿπŸÜŸä ÿ®ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©
                    reviewDate: row[13] || '' // Column N (index 13) - ÿßŸÑŸÖŸàÿπÿØ
                };
            }).filter(item => item.id && item.id.trim() !== '');
        }

        async function findAndDisplayStudent() {
            const searchId = studentIdInput.value.trim();
            if (!searchId) { showError('Please enter a Student ID.'); return; }
            
            loadingDiv.classList.remove('hidden');
            errorDiv.classList.add('hidden');
            resultsContainer.classList.add('hidden');    
            mainBoard.classList.add('hidden');
            
            try {
                if (GOOGLE_SHEET_2_URL.startsWith('REPLACE_WITH')) {
                    throw new Error('The Continuous Assessment sheet URL is not configured.');
                }
                
                const allSheetCsv = await fetchSheetData(GOOGLE_SHEET_1_BASE_URL, SECTION_GIDS_1['All']);
                const allStudents = parseAttendanceCSV(allSheetCsv);
                const studentFromAll = allStudents.find(s => s['Id'] === searchId);

                if (!studentFromAll) {
                    showError(`No record found for Student ID: ${searchId}.`);
                    loadingDiv.classList.add('hidden');
                    return;
                }
                
                const studentSection = studentFromAll['Section'];
                const sectionGid = SECTION_GIDS_1[studentSection];
                
                if (!sectionGid) {
                    throw new Error(`Invalid or unconfigured section "${studentSection}" found for student.`);
                }

                const [sectionSheetCsv, caResponse, finalExamCsv] = await Promise.all([
                    fetchSheetData(GOOGLE_SHEET_1_BASE_URL, sectionGid),
                    fetch(GOOGLE_SHEET_2_URL),
                    fetchSheetData(GOOGLE_SHEET_1_BASE_URL, FINAL_EXAM_GID)
                ]);

                if (!caResponse.ok) {
                    throw new Error('Network error fetching C.A. data.');
                }
                const caCsv = await caResponse.text();

                const sectionAttendanceData = parseAttendanceCSV(sectionSheetCsv);
                
                currentStudentList = sectionAttendanceData.map(s => s['Id']).sort();
                
                const caData = parseCaCSV(caCsv);
                const finalExamData = parseFinalExamCSV(finalExamCsv);

                const attendanceStudent = sectionAttendanceData.find(s => s['Id'] === searchId);
                const caStudent = caData.find(s => s['Id'] === searchId);
                const finalExamStudent = finalExamData.find(s => s.id === searchId);
                
                currentFinalExamStudent = finalExamStudent; // Save for modal

                attendanceContent.innerHTML = '';
                caContent.innerHTML = '';
                mainBoard.innerHTML = '';

                displayMainBoard(attendanceStudent, caStudent, studentSection, finalExamStudent);
                displayAttendanceInfo(attendanceStudent);
                displayCAInfo(caStudent);    
                
                mainViewContainer.classList.remove('hidden');
                resultsContainer.classList.remove('hidden');
                mainBoard.classList.remove('hidden');
                detailsContainer.classList.add('hidden');

            } catch (error) {
                console.error('Error during search:', error);
                showError(error.message || 'Could not load student data. Please check configurations and connection.');
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }
        
        function displayMainBoard(attendanceStudent, caStudent, studentSection, finalExamStudent) {
            const studentName = attendanceStudent ? attendanceStudent['Name'] : (caStudent ? caStudent['Name'] : 'N/A');
            const studentId = attendanceStudent ? attendanceStudent['Id'] : (caStudent ? caStudent['Id'] : 'N/A');

            const labScore = attendanceStudent ? attendanceStudent['Total'] : 'N/A';
            const labScoreNum = parseFloat(labScore) || 0; // Get numeric value for sum

            const quiz1 = caStudent ? parseFloat(caStudent['Q1/10'] || 0) : 0;
            const quiz2 = caStudent ? parseFloat(caStudent['Q2/15'] || 0) : 0;
            const quiz3 = caStudent ? parseFloat(caStudent['Q3/15'] || 0) : 0;
            const quizTotal = quiz1 + quiz2 + quiz3;
            const practicalScore = caStudent ? caStudent['pra'] : 'N/A';
            const practicalScoreNum = parseFloat(practicalScore) || 0; // Get numeric value for sum
            
            // Calculate total score locally
            const calculatedTotal = labScoreNum + quizTotal + practicalScoreNum;
            // Check if any data was available to make a calculation
            const totalScore = (attendanceStudent || caStudent) ? calculatedTotal.toFixed(1) : 'N/A'; // Display with one decimal place, or N/A if no data

            const rank = caStudent ? (caStudent['Rank'] || 'N/A') : 'N/A';
            const rankNum = parseInt(rank);

            // --- Top 3 Celebration Logic ---
            if (!isNaN(rankNum) && rankNum >= 1 && rankNum <= 3) {
                // Execute immediately without delay
                updateCongratsModal(rankNum);
                fireConfetti();
                playCelebrationSound();
                showCongratsModal();
            }

            const quizCircle = caStudent ? createCircularProgressBar(quizTotal, 40, quizTotal.toFixed(1), 'Quizzes') : createCircularProgressBar(0, 40, 'N/A', 'Quizzes');
            const labScoreCircle = attendanceStudent ? createCircularProgressBar(labScore, 10, labScore, 'Lab Score') : createCircularProgressBar(0, 10, 'N/A', 'Lab Score');
            const practicalCircle = caStudent ? createCircularProgressBar(practicalScore, 20, practicalScore, 'Final Practical') : createCircularProgressBar(0, 20, 'N/A', 'Final Practical');
            
            const totalScoreDisplay = totalScore !== 'N/A' ? totalScore : 'N/A';
            const totalScoreHtml = `<p class="text-3xl sm:text-4xl font-bold text-indigo-600 whitespace-nowrap px-4 py-2">${totalScoreDisplay} / 70</p>`;
            const rankHtml = caStudent ? `<p class="text-lg font-semibold text-gray-600 flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>Rank: <span class="text-2xl text-amber-500">${rank}</span></p>` : '';

            // --- Construct Final Exam Card ---
            let finalExamHtml = '';
            if (finalExamStudent) {
                finalExamHtml = `
                <div class="mb-6 mx-auto max-w-4xl transform transition-all hover:scale-[1.01]">
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg shadow-lg text-white overflow-hidden relative">
                         <div class="absolute top-0 right-0 -mr-4 -mt-4 w-24 h-24 rounded-full bg-white opacity-10 blur-xl"></div>
                         <div class="absolute bottom-0 left-0 -ml-4 -mb-4 w-24 h-24 rounded-full bg-white opacity-10 blur-xl"></div>
                         
                         <div class="p-6">
                            <div class="flex items-center mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <h3 class="text-2xl font-bold tracking-tight">Final Lab Exam</h3>
                            </div>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                                <div class="bg-white/10 rounded-lg p-3 backdrop-blur-sm border border-white/20">
                                    <p class="text-xs uppercase tracking-wider opacity-80 mb-1">Date</p>
                                    <p class="text-lg font-bold">${finalExamStudent.date}</p>
                                    <p class="text-sm font-medium opacity-90">${finalExamStudent.day}</p>
                                </div>
                                <div class="bg-white/10 rounded-lg p-3 backdrop-blur-sm border border-white/20">
                                    <p class="text-xs uppercase tracking-wider opacity-80 mb-1">Time</p>
                                    <p class="text-lg font-bold">${finalExamStudent.time}</p>
                                </div>
                                <div class="bg-white/10 rounded-lg p-3 backdrop-blur-sm border border-white/20">
                                    <p class="text-xs uppercase tracking-wider opacity-80 mb-1">Location</p>
                                    <p class="text-lg font-bold flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        ${finalExamStudent.location}
                                    </p>
                                </div>
                            </div>
                         </div>
                    </div>
                </div>
                `;
            }

            const mainBoardHtml = `
                <div class="mb-4 text-center">
                    <h2 class="text-2xl font-bold text-gray-800">${studentName}</h2>
                    <p class="text-gray-500">Student ID: ${studentId}</p>
                    <p class="text-gray-500 mt-1">Section: ${studentSection || 'N/A'}</p>
                </div>
                
                <div class="text-center mb-6 pt-6 border-t">
                    <h3 class="text-xl font-bold text-gray-700 mb-3">Total Score & Rank</h3>
                    <div class="flex flex-col sm:flex-row items-center justify-center gap-4 sm:gap-8 mt-2 px-2">
                        ${totalScoreHtml}
                        ${rankHtml}
                    </div>
                </div>
                
                ${finalExamHtml}

                <h3 class="text-xl font-bold text-gray-700 mb-4 mt-6 pt-6 border-t text-center">Main Grades</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div id="quizzesCardTrigger" class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200 flex flex-col items-center card-hover-effect ${caStudent ? 'cursor-pointer' : 'opacity-50'}">
                        ${quizCircle}
                    </div>
                    <div id="labScoreCardTrigger" class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200 flex flex-col items-center card-hover-effect ${attendanceStudent ? 'cursor-pointer' : 'opacity-50'}">
                        ${labScoreCircle}
                    </div>
                    <!-- Added ID and Logic for triggering the Practical Review Modal -->
                    <div id="practicalScoreCardTrigger" class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200 flex flex-col items-center card-hover-effect ${finalExamStudent ? 'cursor-pointer' : 'opacity-50'}">
                        ${practicalCircle}
                    </div>
                </div>
            `;
            mainBoard.innerHTML = mainBoardHtml;
        }

        const congratsModal = document.getElementById('congratsModal');
        const congratsBgGradient = document.getElementById('congratsBgGradient');
        const congratsIcon = document.getElementById('congratsIcon');
        const congratsTitle = document.getElementById('congratsTitle');
        const congratsRankMsg = document.getElementById('congratsRankMsg');
        const congratsButton = document.getElementById('congratsButton');

        function updateCongratsModal(rank) {
            // Default Gold/Rank 1 settings
            let icon = 'üèÜ';
            // Game-style text gradients (Top to Bottom)
            let titleGradient = 'from-yellow-300 to-yellow-600'; 
            // Glow color
            let glowColor = 'bg-yellow-500';
            // Button style
            let btnGradient = 'from-yellow-400 to-orange-600 border-orange-800';
            let ringColor = 'focus:ring-orange-400';
            let msg = `You are Ranked #${rank}!`;
            
            // Icon Styling (Gold) - Shiny and Metallic
            // saturate: Boosts color to make it rich gold
            // brightness & contrast: Creates the metallic shine
            // drop-shadow: Adds a warm golden glow
            let iconStyle = 'text-8xl mb-6 animate-bounce drop-shadow-[0_0_25px_rgba(234,179,8,0.8)] filter brightness-125 saturate-150 contrast-125';

            if (rank === 2) {
                // Silver Settings - Metallic & Shiny
                icon = 'ü•à';
                titleGradient = 'from-[#E8E8E8] via-[#BCC6CC] to-[#757575]';
                glowColor = 'bg-[#C0C0C0]';
                btnGradient = 'from-[#C0C0C0] to-[#707070] border-[#505050]';
                ringColor = 'focus:ring-gray-400';
                
                // Silver Icon Specifics:
                // grayscale(1): Pure silver/grey
                // brightness & contrast: High shine
                // drop-shadow: Bright silver glow
                iconStyle = 'text-8xl mb-6 animate-bounce drop-shadow-[0_0_25px_#C0C0C0] filter grayscale(1) brightness-125 contrast-150';
                
            } else if (rank === 3) {
                // Bronze Settings - Metallic & Shiny
                icon = 'ü•â';
                titleGradient = 'from-orange-300 to-orange-700'; 
                glowColor = 'bg-orange-600';
                btnGradient = 'from-orange-400 to-orange-700 border-orange-900';
                ringColor = 'focus:ring-orange-500';
                
                // Bronze Icon Specifics:
                // sepia: Gives the reddish/copper tone
                // brightness & contrast: Makes it look like polished metal
                // drop-shadow: Warm copper glow
                iconStyle = 'text-8xl mb-6 animate-bounce drop-shadow-[0_0_25px_rgba(180,83,9,0.8)] filter sepia-[.5] brightness-110 contrast-125';
            }

            // Apply updates
            congratsIcon.textContent = icon;
            congratsIcon.className = iconStyle;
            congratsRankMsg.textContent = msg;
            
            // Apply Glow Class
            congratsBgGradient.className = `absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 rounded-full blur-3xl opacity-40 -z-10 ${glowColor}`;
            
            // Apply Title Gradient
            congratsTitle.className = `text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-b ${titleGradient} mb-2 drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)] filter`;
            
            // Apply Button Styles
            congratsButton.className = `bg-gradient-to-b ${btnGradient} border-b-4 text-white font-bold py-3 px-10 rounded-full shadow-lg transform transition active:scale-95 active:border-b-0 active:translate-y-1 hover:brightness-110 focus:outline-none focus:ring-2 ${ringColor} focus:ring-opacity-50`;
        }
        
        function showCongratsModal() {
            congratsModal.classList.remove('hidden');
        }

        function closeCongratsModal() {
            congratsModal.classList.add('hidden');
        }

        function playCelebrationSound() {
            // ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿµŸàÿ™Ÿä ÿßŸÑÿ£ŸàŸÑ (ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ ÿßŸÑÿßÿ≠ÿ™ŸÅÿßŸÑŸäÿ©)
            const soundUrl1 = "brass-horn-fanfare-charge-epic-stock-media-1-00-03.mp3";
            // ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿµŸàÿ™Ÿä ÿßŸÑÿ´ÿßŸÜŸä (ÿµŸàÿ™ŸÉ)
            const soundUrl2 = "my_voice.mp3";
            
            const audioObj1 = new Audio(soundUrl1);
            audioObj1.volume = 0.6;
            
            // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ£ŸàŸÑ
            const playPromise = audioObj1.play();
            
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.log("Audio 1 play failed (file not found or browser policy):", error);
                });
            }

            // ÿπŸÜÿØ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ£ŸàŸÑÿå ŸÇŸÖ ÿ®ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ´ÿßŸÜŸä
            audioObj1.onended = function() {
                const audioObj2 = new Audio(soundUrl2);
                audioObj2.volume = 0.6;
                audioObj2.play().catch(error => {
                    console.log("Audio 2 play failed:", error);
                });
            };
        }

        function fireConfetti() {
            var duration = 3 * 1000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 70 };

            function randomInRange(min, max) {
              return Math.random() * (max - min) + min;
            }

            var interval = setInterval(function() {
              var timeLeft = animationEnd - Date.now();

              if (timeLeft <= 0) {
                return clearInterval(interval);
              }

              var particleCount = 50 * (timeLeft / duration);
              // since particles fall down, start a bit higher than random
              confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
              confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }

        // ... (Rest of the existing functions: displayAttendanceInfo, displayCAInfo, createCircularProgressBar, zipgrade logic, etc.) ...
        
        function displayAttendanceInfo(student) {
            if (!student) {
                 attendanceContent.innerHTML = '<button class="back-button back-button-sticky hidden sm:block mb-4 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors">‚Üê Back to Main Board</button><p class="text-center text-gray-500">No lab data found for this student.</p><button class="back-button back-button-fab sm:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>';
                 return;
            }

            const topics = {};
            let revisionDate = null;
            let revisionTopic = '';

            for (const key in student) {
                if (key.includes('|')) {
                    const [topic, date, type] = key.split('|');
                    const topicKey = `${topic}|${date}`;

                    if(topic.toLowerCase().includes('revision')) {
                        revisionTopic = topic;
                        revisionDate = date;
                    }

                    if (!topics[topicKey]) { topics[topicKey] = { topic, date, attendance: '', degree: '' }; }
                    if (type === 'Att.') topics[topicKey].attendance = student[key];
                    if (type === 'Deg.') topics[topicKey].degree = student[key];
                }
            }

            let studentGroup = null;
            if (currentStudentList.length > 0 && revisionDate) {
                const midPoint = Math.ceil(currentStudentList.length / 2);
                const studentIndex = currentStudentList.indexOf(student['Id']);
                
                if (studentIndex !== -1) {
                    if (studentIndex < midPoint) {
                        studentGroup = 1;
                    } else {
                        studentGroup = 2;
                    }
                }
            }

            let topicCardsHtml = '';
            for(const key in topics){
                const item = topics[key];
                const isPresent = item.attendance.toUpperCase() === 'TRUE';
                const attendanceMark = isPresent ? '<span class="attendance-tick">‚úì</span>' : '<span class="attendance-cross">‚úó</span>';
                const shadowClass = isPresent ? 'shadow-lg shadow-green-200/60' : 'shadow-lg shadow-red-200/60';

                if (item.topic === 'End of Experiments') {
                    topicCardsHtml += `<div class="bg-blue-50 p-4 rounded-lg shadow-sm border border-blue-200 text-center col-span-1 md:col-span-2 lg:col-span-3"><h3 class="font-semibold text-blue-800">${item.topic}</h3><p class="text-sm text-blue-600">${item.date}</p></div>`;
                } else if (item.topic.toLowerCase().includes('revision')) {
                    let displayDate = item.date;
                    let groupMessage = `Group 1`;
                    
                    if (studentGroup === 2) {
                        const [day, month, year] = item.date.split('/');
                        const originalDate = new Date(`${year}-${month}-${day}`);
                        originalDate.setDate(originalDate.getDate() + 7);
                        displayDate = originalDate.toLocaleDateString('en-GB');
                        groupMessage = `Group 2`;
                    }

                    topicCardsHtml += `
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 transition-shadow duration-300 ${shadowClass} col-span-1 sm:col-span-2 lg:col-span-3">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-semibold text-yellow-800">${item.topic}</h3>
                                <span class="text-xs text-yellow-700 bg-yellow-100 px-2 py-1 rounded-full font-medium">${displayDate}</span>
                            </div>
                            <div class="flex justify-around border-t border-yellow-200 pt-3 mt-3">
                                <div class="text-center">
                                    <p class="text-sm text-yellow-600 mb-1">Attendance</p>
                                    ${attendanceMark}
                                </div>
                                <div class="text-center">
                                    <p class="text-sm text-yellow-600 mb-1">Your Group</p>
                                    <p class="font-bold text-xl text-yellow-800">${studentGroup ? groupMessage : 'N/A'}</p>
                                </div>
                            </div>
                        </div>`;
                } else {
                    topicCardsHtml += `<div class="bg-white p-4 rounded-lg border border-gray-200 transition-shadow duration-300 ${shadowClass}"><div class="flex justify-between items-center mb-3"><h3 class="font-semibold text-gray-800">${item.topic}</h3><span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">${item.date}</span></div><div class="flex justify-around border-t pt-3 mt-3"><div class="text-center"><p class="text-sm text-gray-500 mb-1">Attendance</p>${attendanceMark}</div><div class="text-center"><p class="text-sm text-gray-500 mb-1">Degree</p><p class="font-bold text-xl text-gray-700">${item.degree || '‚Äî'}</p></div></div></div>`;
                }
            }
            
            const resultCard = `
                <button class="back-button back-button-sticky hidden sm:block mb-4 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors">‚Üê Back to Main Board</button>
                
                <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg fade-in mt-4 sm:mt-0">
                    <h3 class="text-xl font-bold text-gray-700 mb-4">Experiments & Attendance</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:col-cols-3 gap-4">${topicCardsHtml}</div>
                </div>

                <button class="back-button back-button-fab sm:hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </button>
            `;
            attendanceContent.innerHTML = resultCard;
        }

        function displayCAInfo(student) {
             if (!student) {
                 caContent.innerHTML = '<button class="back-button back-button-sticky hidden sm:block mb-4 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors">‚Üê Back to Main Board</button><p class="text-center text-gray-500">No assessment data found for this student.</p><button class="back-button back-button-fab sm:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>';
                 return;
            }

            const cards = [
                { title: 'Quiz 1', score: student['Q1/10'], max: 10, type: 'Quiz' },
                { title: 'Quiz 2', score: student['Q2/15'], max: 15, type: 'Quiz' },
                { title: 'Quiz 3', score: student['Q3/15'], max: 15, type: 'Quiz' }
            ];

            let markCardsHtml = cards.map(card => {
                const isQuiz = card.type === 'Quiz';
                const studentAccessCode = student['StudentAccessCode'];
                const hasAccessInfo = isQuiz && studentAccessCode && studentAccessCode.trim() !== '';
                
                const cardClasses = `bg-gradient-to-br from-white to-gray-50 p-4 rounded-lg shadow-sm border border-gray-200 flex flex-col items-center card-hover-effect ${hasAccessInfo ? 'cursor-pointer quiz-card' : ''}`;
                const dataAttributes = hasAccessInfo ? `data-id="${student['Id']}" data-code="${studentAccessCode}"` : '';

                return `<div class="${cardClasses}" ${dataAttributes}>
                            ${createCircularProgressBar(card.score, card.max, card.score, card.title)}
                        </div>`;
            }).join('');
                            
            caContent.innerHTML = `
                <button class="back-button back-button-sticky hidden sm:block mb-4 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors">‚Üê Back to Main Board</button>
                
                <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg fade-in mt-4 sm:mt-0">
                    <h3 class="text-xl font-bold text-gray-700 mb-4">Quiz Details</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">${markCardsHtml}</div>
                </div>

                <button class="back-button back-button-fab sm:hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </button>
            `;
        }

        function createCircularProgressBar(score, maxScore, displayText, title = '') {
            const scoreNum = parseFloat(score);
            const maxScoreNum = parseFloat(maxScore);
            
            let scoreColorClass = 'text-gray-700', progressBarColorClass = 'text-gray-400';
            let progressCircleHtml = '';

            if (!isNaN(scoreNum) && !isNaN(maxScoreNum) && maxScoreNum > 0) {
                const percentage = (scoreNum / maxScoreNum) * 100;
                if (percentage >= 90) { scoreColorClass = 'text-green-600'; progressBarColorClass = 'text-green-600'; }    
                else if (percentage >= 70) { scoreColorClass = 'text-lime-500'; progressBarColorClass = 'text-lime-500'; }    
                else if (percentage >= 50) { scoreColorClass = 'text-yellow-400'; progressBarColorClass = 'text-yellow-400'; }    
                else if (percentage >= 30) { scoreColorClass = 'text-orange-500'; progressBarColorClass = 'text-orange-500'; }    
                else { scoreColorClass = 'text-red-600'; progressBarColorClass = 'text-red-600'; }
                
                const radius = 40;
                const circumference = 2 * Math.PI * radius;
                const offset = circumference - (Math.min(percentage, 100) / 100) * circumference;

                progressCircleHtml = `
                    <svg class="w-full h-full" viewBox="0 0 100 100">
                        <circle class="text-gray-200" stroke-width="10" stroke="currentColor" fill="transparent" r="${radius}" cx="50" cy="50"/>
                        <circle class="${progressBarColorClass}" stroke-width="10" stroke-linecap="round" stroke="currentColor" fill="transparent" r="${radius}" cx="50" cy="50"    
                            style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${offset}; transition: stroke-dashoffset 0.5s ease 0s; transform: rotate(-90deg); transform-origin: 50% 50%;" />
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span class="text-3xl font-bold ${scoreColorClass}">${displayText || 'N/A'}</span>
                        <span class="text-sm text-gray-500">/ ${maxScore}</span>
                    </div>
                `;
            } else {
                progressCircleHtml = `
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span class="text-3xl font-bold text-gray-700">${displayText || 'N/A'}</span>
                    </div>
                `;
            }

            const titleHtml = title ? `<p class="text-base font-bold text-gray-700 mt-2">${title}</p>` : '';

            return `
                <div class="relative w-32 h-32 mt-2">
                    ${progressCircleHtml}
                </div>
                ${titleHtml}
            `;
        }

        const zipgradeModal = document.getElementById('zipgradeModal');
        const practicalReviewModal = document.getElementById('practicalReviewModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const closeReviewModalButton = document.getElementById('closeReviewModalButton');
        const modalStudentId = document.getElementById('modalStudentId');
        const modalAccessCode = document.getElementById('modalAccessCode');

        // ZipGrade Modal Logic
        function showZipgradeModal(studentId, accessCode) {
            modalStudentId.value = studentId;
            modalAccessCode.value = accessCode;
            zipgradeModal.classList.remove('hidden');
        }

        function hideZipgradeModal() {
            zipgradeModal.classList.add('hidden');
        }

        // Practical Review Modal Logic
        function showPracticalReviewModal() {
            if (!currentFinalExamStudent) return;
            
            document.getElementById('reviewExperiment').textContent = currentFinalExamStudent.experiment || '‚Äî';
            document.getElementById('reviewName').textContent = currentFinalExamStudent.reviewer || '‚Äî';
            document.getElementById('reviewDate').textContent = currentFinalExamStudent.reviewDate || '‚Äî';
            // Location is static "ŸÖÿπŸÖŸÑ 304PH" as per request/image, but we also fallback to data if valid
            const loc = currentFinalExamStudent.location || 'ŸÖÿπŸÖŸÑ 304PH';
            document.getElementById('reviewLocation').textContent = loc;
            
            practicalReviewModal.classList.remove('hidden');
        }

        function hidePracticalReviewModal() {
            practicalReviewModal.classList.add('hidden');
        }

        window.copyToClipboard = function(elementId, buttonElement) {
            const input = document.getElementById(elementId);
            input.select();
            input.setSelectionRange(0, 99999);
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(input.value).then(() => {
                        const copyText = buttonElement.querySelector('.copy-text');
                        if(copyText) {
                            copyText.textContent = 'Copied!';
                            setTimeout(() => { copyText.textContent = 'Copy'; }, 2000);
                        }
                        if (window.navigator && window.navigator.vibrate) {
                            window.navigator.vibrate(10);
                        }
                    }).catch(err => {
                        console.error('Failed to copy: ', err);
                        fallbackCopy();
                    });
                } else {
                    fallbackCopy();
                }
                
                function fallbackCopy() {
                    document.execCommand('copy');
                    const copyText = buttonElement.querySelector('.copy-text');
                    if(copyText) {
                        copyText.textContent = 'Copied!';
                        setTimeout(() => { copyText.textContent = 'Copy'; }, 2000);
                    }
                    if (window.navigator && window.navigator.vibrate) {
                        window.navigator.vibrate(10);
                    }
                }
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
            window.getSelection().removeAllRanges();
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            resultsContainer.classList.add('hidden');
        }

        function showDetailPage(type) {
            mainViewContainer.style.opacity = '0';
            setTimeout(() => {
                mainViewContainer.classList.add('hidden');
                detailsContainer.classList.remove('hidden');
                detailsContainer.style.opacity = '0';
                
                attendanceContent.classList.remove('active');
                caContent.classList.remove('active');

                if (type === 'lab') {
                    attendanceContent.classList.add('active');
                } else if (type === 'assessments') {
                    caContent.classList.add('active');
                }
                
                setTimeout(() => {
                    detailsContainer.style.opacity = '1';
                }, 10);
                
                window.scrollTo({top: 0, behavior: 'smooth'});
                
                if (window.navigator && window.navigator.vibrate) {
                    window.navigator.vibrate(5);
                }
            }, 200);
        }
        
        function hideDetailPage() {
            detailsContainer.style.opacity = '0';
            setTimeout(() => {
                mainViewContainer.classList.remove('hidden');
                detailsContainer.classList.add('hidden');
                mainViewContainer.style.opacity = '0';
                
                attendanceContent.classList.remove('active');
                caContent.classList.remove('active');
                
                setTimeout(() => {
                    mainViewContainer.style.opacity = '1';
                }, 10);
                
                window.scrollTo({top: 0, behavior: 'smooth'});
                
                if (window.navigator && window.navigator.vibrate) {
                    window.navigator.vibrate(5);
                }
            }, 200);
        }

        searchButton.addEventListener('click', findAndDisplayStudent);
        studentIdInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') findAndDisplayStudent(); });
        
        mainBoard.addEventListener('click', (event) => {
            const labCard = event.target.closest('#labScoreCardTrigger');
            const quizzesCard = event.target.closest('#quizzesCardTrigger');
            const practicalCard = event.target.closest('#practicalScoreCardTrigger'); // New trigger

            if (labCard && !labCard.classList.contains('opacity-50')) {
                showDetailPage('lab');
            } else if (quizzesCard && !quizzesCard.classList.contains('opacity-50')) {
                showDetailPage('assessments');
            } else if (practicalCard && !practicalCard.classList.contains('opacity-50')) {
                showPracticalReviewModal();
            }
        });
        
        detailsContainer.addEventListener('click', (event) => {
            if (event.target.closest('.back-button')) {
                hideDetailPage();
            }
        });

        closeModalButton.addEventListener('click', hideZipgradeModal);
        zipgradeModal.addEventListener('click', (event) => { if (event.target === zipgradeModal) hideZipgradeModal(); });

        // Practical Review Modal Listeners
        closeReviewModalButton.addEventListener('click', hidePracticalReviewModal);
        practicalReviewModal.addEventListener('click', (event) => { if (event.target === practicalReviewModal) hidePracticalReviewModal(); });

        caContent.addEventListener('click', (event) => {
            const card = event.target.closest('.quiz-card');
            if (card) {
                const studentId = card.dataset.id;
                const accessCode = card.dataset.code;
                showZipgradeModal(studentId, accessCode);
            }
        });

    </script>
</body>
</html>
