<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .attendance-tick {
            color: #10b981;
            font-weight: bold;
            font-size: 1.5rem;
        }
         .attendance-cross {
            color: #ef4444;
            font-weight: bold;
            font-size: 1.5rem;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .card-hover-effect {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        .card-hover-effect:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .card-hover-effect:active {
            transform: scale(0.98);
            box-shadow: 0 2px 4px -1px rgb(0 0 0 / 0.1);
        }
        .back-button-sticky {
            position: -webkit-sticky;
            position: sticky;
            top: 1rem;
            z-index: 10;
        }
        .back-button-fab {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 50;
            background-color: #3b82f6;
            color: white;
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 16px -4px rgb(0 0 0 / 0.3), 0 4px 8px -2px rgb(0 0 0 / 0.2);
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }
        .back-button-fab:active {
            transform: scale(0.95);
            background-color: #2563eb;
        }
        body {
            overscroll-behavior: none;
        }
        .scrollable-content {
            overscroll-behavior: auto;
        }
        html, body {
            overscroll-behavior-y: contain;
        }
        .scrollable-content {
            -webkit-overflow-scrolling: touch;
        }
        input[type="text"] {
            font-size: 16px;
        }
        #mainViewContainer, #detailsContainer {
            transition: opacity 0.2s ease;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        /* Remove click animation from Search button */
        #searchButton:active {
            transform: none;
            opacity: 1;
        }
        #zipgradeModal .bg-white {
            max-height: 90vh;
            overflow-y: auto;
        }
        @media (max-width: 640px) {
            .card-hover-effect {
                position: relative;
                overflow: hidden;
            }
            .card-hover-effect::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                border-radius: 50%;
                background: rgba(59, 130, 246, 0.1);
                transform: translate(-50%, -50%);
                transition: width 0.4s, height 0.4s;
            }
            .card-hover-effect:active::before {
                width: 300px;
                height: 300px;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="mainViewContainer">
        <div class="w-full max-w-5xl mx-auto p-4 md:p-6">
            
            <div class="w-full bg-white rounded-xl shadow-lg p-6 md:p-8">
                <div class="flex items-center mb-6">
                    <div class="flex-shrink-0">
                        <img src="MUST.png" alt="MUST Logo" class="h-24 w-24 object-contain" />
                    </div>
                    <div class="ml-6 flex-grow">
                        <h1 class="text-2xl md:text-3xl font-bold" style="color: #1e3c72;">Misr University for Science and Technology</h1>
                        <p class="text-sm md:text-base mt-1" style="color: #2a5298;">Faculty of Oral and Dental Surgery â€” Fall 2025-2026 PHYS.101 Lab Attendance</p>
                    </div>
                </div>

                <header class="text-center mb-6 pt-6 border-t border-gray-200">
                    <h1 class="text-3xl font-bold text-gray-800">Student Portal</h1>
                    <p class="text-gray-500 mt-2">Enter your Student ID to view your details.</p>
                </header>

                <main>
                    <div class="max-w-lg mx-auto flex flex-col sm:flex-row gap-4">
                        <div class="relative flex-grow">
                            <input type="text" id="studentIdInput" placeholder="Enter Student ID" class="w-full px-4 py-3 text-lg bg-gray-50 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors">
                            <button id="searchButton" class="absolute right-2 top-1/2 -translate-y-1/2 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                                Search
                            </button>
                        </div>
                    </div>

                    <div id="loading" class="text-center mt-6 hidden">
                         <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                         <p class="text-gray-500 mt-2">Fetching data...</p>
                    </div>
                    
                    <div id="resultsContainer" class="hidden">
                        <div id="mainBoard" class="fade-in mt-6 hidden">
                        </div>
                    </div>

                     <div id="error" class="text-center mt-6 text-red-500 font-medium hidden"></div>
                </main>
            </div>
        </div>
        
        <footer class="w-full text-center p-6 mt-auto">
            <p class="text-gray-600">Wishing you the best of luck in your studies!</p>
            <div class="mt-2 text-gray-500 text-sm">
                <p>Dr. Mohamed Ali</p>
                <p>Center of Basic Sciences, Physics Department</p>
                <p>+201002836484</p>
            </div>
        </footer>
    </div>

    <div id="detailsContainer" class="w-full max-w-5xl mx-auto p-4 md:p-6 hidden scrollable-content">
        <div>
            <div id="attendanceContent" class="tab-content">
            </div>
            <div id="caContent" class="tab-content">
            </div>
        </div>
    </div>
    
    <div id="zipgradeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-center fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">ZipGrade Login Info</h2>
            <p class="text-gray-500 mb-6">Use these details to log in on the ZipGrade website.</p>

            <div class="space-y-4">
                <div>
                    <label class="block text-left text-sm font-medium text-gray-500">ZipGrade Student ID</label>
                    <div class="relative mt-1">
                        <input type="text" id="modalStudentId" readonly class="w-full bg-gray-100 border border-gray-300 rounded-md px-3 py-2 text-lg">
                        <button onclick="copyToClipboard('modalStudentId', this)" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-blue-500">
                            <span class="copy-text">Copy</span>
                            <svg class="h-6 w-6 copy-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-left text-sm font-medium text-gray-500">Student Access Code</label>
                    <div class="relative mt-1">
                        <input type="text" id="modalAccessCode" readonly class="w-full bg-gray-100 border border-gray-300 rounded-md px-3 py-2 text-lg">
                         <button onclick="copyToClipboard('modalAccessCode', this)" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-blue-500">
                            <span class="copy-text">Copy</span>
                            <svg class="h-6 w-6 copy-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <a href="https://zipgrade.com/s/" target="_blank" class="mt-6 inline-block w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-colors">
                Go to ZipGrade
            </a>

            <button id="closeModalButton" class="mt-4 text-sm text-gray-500 hover:text-gray-700">Close</button>
        </div>
    </div>

    <script>
        const GOOGLE_SHEET_1_BASE_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTTAvVKy59t4ZTV_GQPKQbUS-tchpK9OugsPXL41ScMQXsA1pDh467cksdR32pct8_bjgpOJ4NpgrZA/pub?output=csv&single=true';
        const FINAL_EXAM_GID = '1063209357';
        
        const SECTION_GIDS_1 = {
            'All': '1650908958', 'A': '1620275840', 'B': '1661871665', 'C': '804746623', 'D': '1998860796', 'E': '1432194061', 'F': '1174976610', 'G': '630589668', 'H': '340172703', 'I': '1823887500', 'J': '1811748047', 'K': '289568000', 'L': '1058769797', 'M': '672465296', 'N': '2018867860', 'O': '2510390', 'P': '1022038284', 'Q': '747459593', 'R': '1912599889', 'S': '554652905', 'T': '1568050738'
        };

        const GOOGLE_SHEET_2_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSwOgvVGMBZkhsJY_dTFepiWNuK42nVXTg5ATU1jd0In027rMCC8Qx0o8Wcl7JHMxCNGtUXUMpVsiLv/pub?output=csv';

        const studentIdInput = document.getElementById('studentIdInput');
        const searchButton = document.getElementById('searchButton');
        
        const mainViewContainer = document.getElementById('mainViewContainer');
        const detailsContainer = document.getElementById('detailsContainer');
        
        const resultsContainer = document.getElementById('resultsContainer');
        const mainBoard = document.getElementById('mainBoard'); 
        const attendanceContent = document.getElementById('attendanceContent');
        const caContent = document.getElementById('caContent');
        
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');

        let currentStudentList = [];
        let fullAttendanceData = {};
        
        let touchstartX = 0;
        let touchendX = 0;
        const swipeThreshold = 80;
        let touchstartY = 0;
        let touchendY = 0;
        let isScrolling = null;
        let swipeHandled = false;

        document.body.addEventListener('touchstart', e => {
            if (!detailsContainer.classList.contains('hidden')) {
                touchstartX = e.changedTouches[0].screenX;
                touchstartY = e.changedTouches[0].screenY;
                isScrolling = null;
                swipeHandled = false;
                
                const fab = document.querySelector('.back-button-fab');
                if (fab && touchstartX < (window.innerWidth / 8)) {
                    fab.style.transform = 'scale(1.1)';
                }
            }
        }, { passive: true });

        document.body.addEventListener('touchmove', e => {
            if (!detailsContainer.classList.contains('hidden') && touchstartX !== 0) {
                const deltaX = e.changedTouches[0].screenX - touchstartX;
                const deltaY = e.changedTouches[0].screenY - touchstartY;

                if (isScrolling === null) {
                    isScrolling = Math.abs(deltaY) > Math.abs(deltaX);
                }

                if (!isScrolling && deltaX > 0 && touchstartX < (window.innerWidth / 8)) {
                    if (e.cancelable) {
                        e.preventDefault();
                    }
                    
                    swipeHandled = true;
                    
                    const progress = Math.min(deltaX / 150, 1);
                    detailsContainer.style.opacity = 1 - (progress * 0.3);
                    detailsContainer.style.transform = `translateX(${deltaX * 0.5}px)`;
                }
            }
        }, { passive: false });

        document.body.addEventListener('touchend', e => {
            if (!detailsContainer.classList.contains('hidden') && touchstartX !== 0) {
                touchendX = e.changedTouches[0].screenX;
                touchendY = e.changedTouches[0].screenY;
                
                if (swipeHandled) {
                    handleSwipeGesture(e); // Pass the event object
                }
                
                detailsContainer.style.opacity = '1';
                detailsContainer.style.transform = 'translateX(0)';
                const fab = document.querySelector('.back-button-fab');
                if (fab) fab.style.transform = 'scale(1)';
            }
            touchstartX = 0;
            touchstartY = 0;
            touchendX = 0;
            touchendY = 0;
            isScrolling = null;
            swipeHandled = false;
        });

        function handleSwipeGesture(event) {
            const deltaX = touchendX - touchstartX;
            const deltaY = touchendY - touchstartY;

            if (Math.abs(deltaX) > Math.abs(deltaY) && deltaX > swipeThreshold) {
                if (touchstartX < (window.innerWidth / 8)) {
                    if (event) { // Check if event exists
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    
                    hideDetailPage();
                    
                    if (window.navigator && window.navigator.vibrate) {
                        window.navigator.vibrate(10);
                    }
                }
            }
        }

        async function fetchSheetData(baseUrl, gid) {
            const fetchUrl = `${baseUrl}&gid=${gid}`;
            const response = await fetch(fetchUrl);
            if (!response.ok) throw new Error(`Network error fetching data for GID ${gid}.`);
            return await response.text();
        }
        
        function parseAttendanceCSV(text) {
            const rows = text.split(/\r?\n/).map(row => row.split(',').map(cell => {
                let cleanCell = cell.trim();
                if (cleanCell.startsWith('"') && cleanCell.endsWith('"')) { cleanCell = cleanCell.substring(1, cleanCell.length - 1); }
                return cleanCell;
            }));
            if (rows.length < 5) return [];
            const topicRow = rows[0], dateRow = rows[1], headerRow = rows[3], dataRows = rows.slice(4);
            const structuredHeaders = [];
            let currentTopic = '', currentDate = '';
            for (let i = 0; i < headerRow.length; i++) {
                if (topicRow[i]) currentTopic = topicRow[i];
                if (dateRow[i]) currentDate = dateRow[i];
                let header = headerRow[i];
                if (i === 5) { structuredHeaders.push('Section'); continue; }
                if (header === 'Att.' || header === 'Deg.') { structuredHeaders.push(`${currentTopic}|${currentDate}|${header}`); } 
                else { structuredHeaders.push(header); }
            }
            const data = dataRows.map(row => {
                const student = {};
                structuredHeaders.forEach((header, index) => { student[header] = row[index] || ''; });
                return student;
            }).filter(student => student['Id']);
            return data;
        }

        function parseCaCSV(text) {
            const rows = text.split(/\r?\n/).map(row => row.split(',').map(cell => cell.trim()));
            if (rows.length < 6) return []; 
            const headers = rows[4]; 
            const dataRows = rows.slice(5);

            const idColumnIndex = headers.findIndex(h => h.toLowerCase().includes('id'));
            const accessCodeColumnIndex = headers.findIndex(h => h.toLowerCase().includes('access code'));
            
            if (idColumnIndex === -1) {
                console.error("Could not find a column with 'id' in the C.A. sheet's 5th row.");
                return []; 
            }
            return dataRows.map(row => {
                const student = {};
                headers.forEach((header, index) => {
                    student[header] = row[index] || '';
                });
                student['Id'] = row[idColumnIndex] || '';
                student['StudentAccessCode'] = accessCodeColumnIndex !== -1 ? row[accessCodeColumnIndex] || '' : '';
                return student;
            }).filter(student => student['Id'] && student['Id'].trim() !== '');
        }

        // --- NEW FUNCTION TO PARSE FINAL EXAM DATA ---
        function parseFinalExamCSV(text) {
             const rows = text.split(/\r?\n/).map(row => row.split(',').map(cell => {
                let cleanCell = cell.trim();
                // Remove quotes if present
                if (cleanCell.startsWith('"') && cleanCell.endsWith('"')) {
                     cleanCell = cleanCell.substring(1, cleanCell.length - 1);
                }
                return cleanCell;
            }));
            
            // Check for valid data length
            if (rows.length < 2) return [];

            // Mapping based on your screenshot:
            // Column Index (0-based): 
            // 1: ID (B)
            // 4: DAY (E)
            // 5: TIME (F)
            // 6: DATE (G)
            // 7: LOCATION (H)
            
            // Skip the header row (row 0)
            const dataRows = rows.slice(1);

            return dataRows.map(row => {
                return {
                    id: row[1] || '',
                    day: row[4] || '',
                    time: row[5] || '',
                    date: row[6] || '',
                    location: row[7] || ''
                };
            }).filter(item => item.id && item.id.trim() !== '');
        }

        async function findAndDisplayStudent() {
            const searchId = studentIdInput.value.trim();
            if (!searchId) { showError('Please enter a Student ID.'); return; }
            
            loadingDiv.classList.remove('hidden');
            errorDiv.classList.add('hidden');
            resultsContainer.classList.add('hidden'); 
            mainBoard.classList.add('hidden');
            
            try {
                if (GOOGLE_SHEET_2_URL.startsWith('REPLACE_WITH')) {
                    throw new Error('The Continuous Assessment sheet URL is not configured.');
                }
                
                const allSheetCsv = await fetchSheetData(GOOGLE_SHEET_1_BASE_URL, SECTION_GIDS_1['All']);
                const allStudents = parseAttendanceCSV(allSheetCsv);
                const studentFromAll = allStudents.find(s => s['Id'] === searchId);

                if (!studentFromAll) {
                    showError(`No record found for Student ID: ${searchId}.`);
                    loadingDiv.classList.add('hidden');
                    return;
                }
                
                const studentSection = studentFromAll['Section'];
                const sectionGid = SECTION_GIDS_1[studentSection];
                
                if (!sectionGid) {
                    throw new Error(`Invalid or unconfigured section "${studentSection}" found for student.`);
                }

                // Updated Promise.all to fetch Final Exam data as well
                const [sectionSheetCsv, caResponse, finalExamCsv] = await Promise.all([
                    fetchSheetData(GOOGLE_SHEET_1_BASE_URL, sectionGid),
                    fetch(GOOGLE_SHEET_2_URL),
                    fetchSheetData(GOOGLE_SHEET_1_BASE_URL, FINAL_EXAM_GID)
                ]);

                if (!caResponse.ok) {
                    throw new Error('Network error fetching C.A. data.');
                }
                const caCsv = await caResponse.text();

                const sectionAttendanceData = parseAttendanceCSV(sectionSheetCsv);
                
                currentStudentList = sectionAttendanceData.map(s => s['Id']).sort();
                
                const caData = parseCaCSV(caCsv);
                const finalExamData = parseFinalExamCSV(finalExamCsv);

                const attendanceStudent = sectionAttendanceData.find(s => s['Id'] === searchId);
                const caStudent = caData.find(s => s['Id'] === searchId);
                const finalExamStudent = finalExamData.find(s => s.id === searchId);
                
                attendanceContent.innerHTML = '';
                caContent.innerHTML = '';
                mainBoard.innerHTML = '';

                // Pass finalExamStudent to the display function
                displayMainBoard(attendanceStudent, caStudent, studentSection, finalExamStudent);
                displayAttendanceInfo(attendanceStudent);
                displayCAInfo(caStudent); 
                
                mainViewContainer.classList.remove('hidden');
                resultsContainer.classList.remove('hidden');
                mainBoard.classList.remove('hidden');
                detailsContainer.classList.add('hidden');

            } catch (error) {
                console.error('Error during search:', error);
                showError(error.message || 'Could not load student data. Please check configurations and connection.');
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }
        
        // Updated to accept finalExamStudent
        function displayMainBoard(attendanceStudent, caStudent, studentSection, finalExamStudent) {
            const studentName = attendanceStudent ? attendanceStudent['Name'] : (caStudent ? caStudent['Name'] : 'N/A');
            const studentId = attendanceStudent ? attendanceStudent['Id'] : (caStudent ? caStudent['Id'] : 'N/A');

            const labScore = attendanceStudent ? attendanceStudent['Total'] : 'N/A';

            const quiz1 = caStudent ? parseFloat(caStudent['Q1/10'] || 0) : 0;
            const quiz2 = caStudent ? parseFloat(caStudent['Q2/15'] || 0) : 0;
            const quiz3 = caStudent ? parseFloat(caStudent['Q3/15'] || 0)
